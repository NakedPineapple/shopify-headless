<!DOCTYPE html>
<html lang="en" class="{% block html_class %}{% endblock %}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#d63a2f" id="theme-color-meta">
    <title>{% block title %}Naked Pineapple{% endblock %}</title>

    <!-- Theme initialization - prevents flash of wrong theme -->
    <script>
    (function() {
        var stored = localStorage.getItem('theme');
        var prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        // 'system' or no stored value = follow OS, otherwise use stored value
        var isDark = (stored === 'dark') || (stored !== 'light' && prefersDark);
        if (isDark) {
            document.documentElement.classList.add('dark');
            document.getElementById('theme-color-meta')?.setAttribute('content', '#1a1a1a');
        }
    })();
    </script>

    <!-- Preconnect to external domains -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Fonts: Playfair Display (headlines) + DM Sans (body) -->
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet">

    <!-- HTMX -->
    <script src="/static/vendor/htmx.min.js"></script>

    <!-- Phosphor Icons -->
    <link rel="stylesheet" href="/static/vendor/phosphor-icons.css">

    <!-- CSS -->
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/vendor/swiper-bundle.min.css">

    <!-- Meta tags -->
    {% block meta %}
    <meta name="description" content="{% block description %}Discover Naked Pineapple, an authentic skincare brand with high-quality, natural ingredients like pineapple extract and vegan collagen.{% endblock %}">
    {% endblock %}

    <!-- Open Graph -->
    <meta property="og:title" content="{% block og_title %}Naked Pineapple{% endblock %}">
    <meta property="og:description" content="{% block og_description %}Natural skincare powered by pineapple enzymes{% endblock %}">
    <meta property="og:type" content="{% block og_type %}website{% endblock %}">
    <meta property="og:image" content="{% block og_image %}{% endblock %}">

    <!-- Analytics - Head Scripts -->
    {% block ga4_script %}{% endblock %}
    {% block sentry_script %}{% endblock %}

    {% block head %}{% endblock %}
</head>
<body class="min-h-screen bg-background text-foreground font-sans antialiased {% block body_class %}{% endblock %}" hx-boost="true">
    <!-- Skip to main content link for accessibility -->
    <a href="#main" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-primary text-primary-foreground px-4 py-2 rounded-full font-medium z-50">
        Skip to main content
    </a>

    <div class="flex flex-col min-h-screen">
        <!-- Announcement Bar -->
        {% block announcement_bar %}
        {% include "partials/announcement_bar.html" %}
        {% endblock %}

        <!-- Header -->
        {% block header %}
        {% include "partials/header.html" %}
        {% endblock %}

        <!-- Main content -->
        <main id="main" class="flex-1" role="main" tabindex="-1">
            {% block content %}{% endblock %}
        </main>

        <!-- Footer -->
        {% block footer %}
        {% include "partials/footer.html" %}
        {% endblock %}
    </div>

    <!-- Quick View Sidebar -->
    <div id="quick-view-overlay"
         class="fixed inset-0 bg-black/50 z-40 opacity-0 pointer-events-none transition-opacity duration-300"
         onclick="closeQuickView()"></div>
    <aside id="quick-view-sidebar"
           class="fixed top-0 right-0 h-full w-full max-w-md bg-background z-50 shadow-2xl transform translate-x-full transition-transform duration-300 ease-out overflow-y-auto"
           aria-label="Quick view">
        <div class="sticky top-0 bg-background z-10 flex items-center justify-between p-4 border-b border-border">
            <h2 class="text-sm font-medium uppercase tracking-wider text-muted-foreground">Quick View</h2>
            <button type="button"
                    class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-muted transition-colors"
                    onclick="closeQuickView()"
                    aria-label="Close quick view">
                <i class="ph ph-x text-xl"></i>
            </button>
        </div>
        <div id="quick-view-content" class="p-6">
            <!-- Content loaded via HTMX -->
        </div>
    </aside>

    <!-- Newsletter Popup Container -->
    <div id="newsletter-popup"></div>

    <!-- Swiper.js (local vendor) -->
    <script src="/static/vendor/swiper-bundle.min.js"></script>

    <!-- Base Scripts -->
    <script>
    // Guard against re-execution on HTMX navigation
    if (!window._baseScriptInitialized) {
        window._baseScriptInitialized = true;

        // Global error handler
        window.addEventListener('error', function(e) {
            console.error('JS Error:', e.message, 'at', e.filename, ':', e.lineno);
        });
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
        });

        // HTMX error handling
        document.body.addEventListener('htmx:error', function(e) {
            console.error('HTMX error:', e.detail);
        });
        document.body.addEventListener('htmx:sendError', function(e) {
            console.error('HTMX send error:', e.detail);
        });

        // Quick View functionality
        window.openQuickView = function() {
            var sidebar = document.getElementById('quick-view-sidebar');
            var overlay = document.getElementById('quick-view-overlay');
            if (!sidebar || !overlay) return;

            overlay.classList.remove('opacity-0', 'pointer-events-none');
            overlay.classList.add('opacity-100', 'pointer-events-auto');
            sidebar.classList.remove('translate-x-full');
            sidebar.classList.add('translate-x-0');
            document.body.style.overflow = 'hidden';
        };

        window.closeQuickView = function() {
            var sidebar = document.getElementById('quick-view-sidebar');
            var overlay = document.getElementById('quick-view-overlay');
            if (!sidebar || !overlay) return;

            overlay.classList.add('opacity-0', 'pointer-events-none');
            overlay.classList.remove('opacity-100', 'pointer-events-auto');
            sidebar.classList.add('translate-x-full');
            sidebar.classList.remove('translate-x-0');
            document.body.style.overflow = '';
        };

        // Close on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                window.closeQuickView();
                window.closeMobileMenu();
                window.closeSearchDrawer();
            }
        });

        // Clean up on HTMX navigation (but not for search results within the drawer)
        document.body.addEventListener('htmx:beforeSwap', function(e) {
            var target = e.detail.target;
            var isSearchResults = target && target.id === 'search-results';
            window.closeQuickView();
            if (!isSearchResults) {
                window.closeSearchDrawer();
            }
        });

        // Mobile menu functionality
        window.openMobileMenu = function() {
            var menu = document.getElementById('mobile-menu');
            var overlay = document.getElementById('mobile-menu-overlay');
            if (!menu || !overlay) return;

            menu.hidden = false;
            overlay.classList.remove('opacity-0', 'invisible');
            overlay.classList.add('opacity-100', 'visible');
            setTimeout(function() {
                menu.classList.add('is-open');
            }, 10);
            document.body.style.overflow = 'hidden';
        };

        window.closeMobileMenu = function() {
            var menu = document.getElementById('mobile-menu');
            var overlay = document.getElementById('mobile-menu-overlay');
            if (!menu || !overlay) return;

            menu.classList.remove('is-open');
            overlay.classList.add('opacity-0', 'invisible');
            overlay.classList.remove('opacity-100', 'visible');
            document.body.style.overflow = '';
            setTimeout(function() {
                menu.hidden = true;
            }, 300);
        };

        // Search drawer functionality
        window.openSearchDrawer = function() {
            var drawer = document.getElementById('search-drawer');
            var overlay = document.getElementById('search-drawer-overlay');
            var input = document.getElementById('search-input');
            if (!drawer || !overlay) return;

            drawer.hidden = false;
            overlay.classList.remove('opacity-0', 'invisible');
            overlay.classList.add('opacity-100', 'visible');
            setTimeout(function() {
                drawer.classList.add('is-open');
                if (input) input.focus();
            }, 10);
            document.body.style.overflow = 'hidden';
        };

        window.closeSearchDrawer = function() {
            var drawer = document.getElementById('search-drawer');
            var overlay = document.getElementById('search-drawer-overlay');
            if (!drawer || !overlay) return;

            drawer.classList.remove('is-open');
            overlay.classList.add('opacity-0', 'invisible');
            overlay.classList.remove('opacity-100', 'visible');
            document.body.style.overflow = '';
            setTimeout(function() {
                drawer.hidden = true;
            }, 300);
        };

        // Search input clear button visibility
        document.addEventListener('input', function(e) {
            if (e.target.id === 'search-input') {
                var clearBtn = document.getElementById('search-clear');
                if (clearBtn) {
                    clearBtn.classList.toggle('hidden', !e.target.value);
                }
            }
        });

        // Handle search form reset
        document.addEventListener('click', function(e) {
            if (e.target.id === 'search-clear' || e.target.closest('#search-clear')) {
                var input = document.getElementById('search-input');
                var results = document.getElementById('search-results');
                if (input) {
                    input.value = '';
                    input.focus();
                }
                if (results) {
                    results.innerHTML = '<div class="text-center text-muted-foreground py-8"><i class="ph ph-magnifying-glass text-4xl mb-3 block opacity-50"></i><p>Start typing to search</p></div>';
                }
                var clearBtn = document.getElementById('search-clear');
                if (clearBtn) clearBtn.classList.add('hidden');
            }
        });

        // Quantity selector functionality
        document.addEventListener('click', function(e) {
            var btn = e.target.closest('.quantity-btn');
            if (!btn) return;

            var container = btn.closest('.quantity-selector');
            var input = container.querySelector('.quantity-input');
            var currentValue = parseInt(input.value) || 1;
            var min = parseInt(input.min) || 1;
            var max = parseInt(input.max) || 999;

            if (btn.dataset.action === 'decrease' && currentValue > min) {
                input.value = currentValue - 1;
            } else if (btn.dataset.action === 'increase' && currentValue < max) {
                input.value = currentValue + 1;
            }
        });

        // Close quick view when clicking "View Full Details" link
        document.addEventListener('click', function(e) {
            if (e.target.closest('[data-close-quick-view]')) {
                window.closeQuickView();
            }
        });

        // Theme toggle functionality (3-way: light / dark / system)
        window.getThemePreference = function() {
            return localStorage.getItem('theme') || 'system';
        };

        window.getEffectiveTheme = function() {
            var pref = window.getThemePreference();
            if (pref === 'system') {
                return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }
            return pref;
        };

        window.applyTheme = function() {
            var html = document.documentElement;
            var meta = document.getElementById('theme-color-meta');
            var effective = window.getEffectiveTheme();

            if (effective === 'dark') {
                html.classList.add('dark');
                if (meta) meta.setAttribute('content', '#1a1a1a');
            } else {
                html.classList.remove('dark');
                if (meta) meta.setAttribute('content', '#d63a2f');
            }
            window.updateThemeIcons();
        };

        window.setTheme = function(theme) {
            if (theme === 'system') {
                localStorage.removeItem('theme');
            } else {
                localStorage.setItem('theme', theme);
            }
            window.applyTheme();
        };

        window.cycleTheme = function() {
            var current = window.getThemePreference();
            // Cycle: system -> light -> dark -> system
            var next = current === 'system' ? 'light' : (current === 'light' ? 'dark' : 'system');
            window.setTheme(next);
        };

        window.updateThemeIcons = function() {
            var pref = window.getThemePreference();
            document.querySelectorAll('.theme-icon-sun').forEach(function(el) {
                el.classList.toggle('hidden', pref !== 'light');
            });
            document.querySelectorAll('.theme-icon-moon').forEach(function(el) {
                el.classList.toggle('hidden', pref !== 'dark');
            });
            document.querySelectorAll('.theme-icon-system').forEach(function(el) {
                el.classList.toggle('hidden', pref !== 'system');
            });
            // Update aria-label
            document.querySelectorAll('[data-theme-toggle]').forEach(function(el) {
                var labels = { light: 'Light mode (click for dark)', dark: 'Dark mode (click for system)', system: 'System mode (click for light)' };
                el.setAttribute('aria-label', labels[pref] || 'Toggle theme');
            });
        };

        // Initialize theme icons on page load
        window.updateThemeIcons();

        // Listen for system theme changes (applies when preference is 'system')
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function() {
            window.applyTheme();
        });

        // Page component initialization
        window.initPageComponents = function() {
            // Initialize hero carousel (Swiper)
            document.querySelectorAll('.hero-carousel:not([data-initialized])').forEach(function(heroCarousel) {
                if (window._heroSwiper) {
                    window._heroSwiper.destroy(true, true);
                }

                var autoplayDelay = parseInt(heroCarousel.dataset.autoplay) || 5000;
                heroCarousel.style.setProperty('--autoplay-duration', autoplayDelay + 'ms');

                window._heroSwiper = new Swiper(heroCarousel, {
                    loop: true,
                    speed: 800,
                    centeredSlides: true,
                    slidesPerView: 1.15,
                    spaceBetween: 20,
                    autoplay: {
                        delay: autoplayDelay,
                        disableOnInteraction: false,
                    },
                    pagination: {
                        el: '.swiper-pagination',
                        clickable: true,
                    },
                    navigation: {
                        nextEl: '.swiper-button-next',
                        prevEl: '.swiper-button-prev',
                    },
                    breakpoints: {
                        0: { slidesPerView: 1.08, spaceBetween: 12 },
                        768: { slidesPerView: 1.12, spaceBetween: 16 },
                        1024: { slidesPerView: 1.18, spaceBetween: 24 },
                    },
                });
                heroCarousel.dataset.initialized = 'true';
            });

            // Initialize tabs with slide + fade animation (only if not already initialized)
            document.querySelectorAll('.tabs:not([data-initialized])').forEach(function(tabContainer) {
                var buttons = tabContainer.querySelectorAll('.tab-btn');
                var section = tabContainer.closest('section');
                if (!section) return;
                var panels = section.querySelectorAll('.tab-panel');
                var isAnimating = false;

                buttons.forEach(function(button) {
                    button.addEventListener('click', function() {
                        var index = button.dataset.index;
                        var currentPanel = section.querySelector('.tab-panel[data-active="true"]');
                        var nextPanel = section.querySelector('.tab-panel[data-index="' + index + '"]');

                        // Skip if already on this tab or animating
                        if (!nextPanel || currentPanel === nextPanel || isAnimating) return;
                        isAnimating = true;

                        // Update button states
                        buttons.forEach(function(btn) {
                            btn.dataset.active = 'false';
                            btn.setAttribute('aria-selected', 'false');
                        });
                        button.dataset.active = 'true';
                        button.setAttribute('aria-selected', 'true');

                        // Animate out current panel
                        currentPanel.classList.add('opacity-0', 'translate-y-8');
                        currentPanel.dataset.active = 'false';

                        // After transition, swap positions and animate in
                        setTimeout(function() {
                            // Move current panel out of flow
                            currentPanel.classList.add('absolute', 'inset-x-0', 'pointer-events-none');

                            // Prepare next panel (still invisible but in flow)
                            nextPanel.classList.remove('absolute', 'inset-x-0', 'pointer-events-none');
                            nextPanel.dataset.active = 'true';

                            // Force reflow, then animate in
                            nextPanel.offsetHeight;
                            nextPanel.classList.remove('opacity-0', 'translate-y-8');

                            // Animation complete
                            setTimeout(function() {
                                isAnimating = false;
                            }, 300);
                        }, 300);
                    });
                });
                tabContainer.dataset.initialized = 'true';
            });

            // Initialize Before/After comparison slider
            var compareSlider = document.getElementById('compare-slider');
            if (compareSlider && !compareSlider.dataset.initialized) {
                var handle = document.getElementById('slider-handle');
                var beforeContainer = document.getElementById('before-container');
                var afterLabelContainer = document.getElementById('after-label-container');

                if (handle && beforeContainer && afterLabelContainer) {
                    var isDragging = false;

                    var updateSlider = function(x) {
                        var rect = compareSlider.getBoundingClientRect();
                        var percentage = ((x - rect.left) / rect.width) * 100;
                        percentage = Math.max(10, Math.min(90, percentage));
                        handle.style.left = percentage + '%';
                        beforeContainer.style.clipPath = 'inset(0 ' + (100 - percentage) + '% 0 0)';
                        afterLabelContainer.style.clipPath = 'inset(0 0 0 ' + percentage + '%)';
                    };

                    handle.addEventListener('mousedown', function() { isDragging = true; });
                    document.addEventListener('mouseup', function() { isDragging = false; });
                    document.addEventListener('mousemove', function(e) {
                        if (!isDragging) return;
                        e.preventDefault();
                        updateSlider(e.clientX);
                    });
                    compareSlider.addEventListener('click', function(e) { updateSlider(e.clientX); });

                    // Touch events
                    handle.addEventListener('touchstart', function() { isDragging = true; }, { passive: true });
                    document.addEventListener('touchend', function() { isDragging = false; });
                    document.addEventListener('touchmove', function(e) {
                        if (!isDragging) return;
                        updateSlider(e.touches[0].clientX);
                    }, { passive: true });

                    compareSlider.dataset.initialized = 'true';
                }
            }

            // Initialize Before/After mobile tap toggle
            var toggleContainer = document.getElementById('toggle-container');
            if (toggleContainer && !toggleContainer.dataset.initialized) {
                var toggleBefore = document.getElementById('toggle-before');
                var toggleAfter = document.getElementById('toggle-after');
                var toggleLabel = document.getElementById('toggle-label');

                if (toggleBefore && toggleAfter && toggleLabel) {
                    var showingAfter = false;
                    toggleContainer.addEventListener('click', function() {
                        showingAfter = !showingAfter;
                        if (showingAfter) {
                            toggleBefore.classList.add('opacity-0');
                            toggleAfter.classList.remove('opacity-0');
                            toggleLabel.textContent = 'After';
                            toggleLabel.classList.remove('bg-text/80');
                            toggleLabel.classList.add('bg-primary');
                        } else {
                            toggleBefore.classList.remove('opacity-0');
                            toggleAfter.classList.add('opacity-0');
                            toggleLabel.textContent = 'Before';
                            toggleLabel.classList.remove('bg-primary');
                            toggleLabel.classList.add('bg-text/80');
                        }
                    });
                    toggleContainer.dataset.initialized = 'true';
                }
            }
        };

        // Run on initial page load
        window.initPageComponents();

        // Run after HTMX swaps content (for hx-boost navigation)
        document.body.addEventListener('htmx:afterSettle', window.initPageComponents);
    }
    </script>

    {% block scripts %}{% endblock %}

    <!-- Analytics script - loaded after other scripts -->
    {% block analytics_script %}{% endblock %}
</body>
</html>
