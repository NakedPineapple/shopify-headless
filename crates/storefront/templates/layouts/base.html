<!DOCTYPE html>
<html lang="en" class="{% block html_class %}{% endblock %}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#d63a2f" id="theme-color-meta">
    <title>{% block title %}Naked Pineapple{% endblock %}</title>

    <!-- Theme initialization - prevents flash of wrong theme -->
    <script>
    (function() {
        var stored = localStorage.getItem('theme');
        var prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        // 'system' or no stored value = follow OS, otherwise use stored value
        var isDark = (stored === 'dark') || (stored !== 'light' && prefersDark);
        if (isDark) {
            document.documentElement.classList.add('dark');
            document.getElementById('theme-color-meta')?.setAttribute('content', '#1a1a1a');
        }
    })();
    </script>

    <!-- Preconnect to external domains -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Fonts: Playfair Display (headlines) + DM Sans (body) -->
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet">

    <!-- Phosphor Icons (regular + fill weights) -->
    <link rel="stylesheet" href="https://unpkg.com/@phosphor-icons/web@2.1.1/src/regular/style.css">
    <link rel="stylesheet" href="https://unpkg.com/@phosphor-icons/web@2.1.1/src/fill/style.css">

    <!-- CSS -->
    <link rel="stylesheet" href="/static/css/main.css">

    <!-- Meta tags -->
    {% block meta %}
    <meta name="description" content="{% block description %}Discover Naked Pineapple, an authentic skincare brand with high-quality, natural ingredients like pineapple extract and vegan collagen.{% endblock %}">
    {% endblock %}

    <!-- Open Graph -->
    <meta property="og:title" content="{% block og_title %}Naked Pineapple{% endblock %}">
    <meta property="og:description" content="{% block og_description %}Natural skincare powered by pineapple enzymes{% endblock %}">
    <meta property="og:type" content="{% block og_type %}website{% endblock %}">
    <meta property="og:image" content="{% block og_image %}{% endblock %}">

    <!-- Analytics - Head Scripts -->
    {% block ga4_script %}{% endblock %}
    {% block sentry_script %}{% endblock %}

    {% block head %}{% endblock %}
</head>
<body class="min-h-screen bg-background text-foreground font-sans antialiased {% block body_class %}{% endblock %}" hx-boost="true">
    <!-- Skip to main content link for accessibility -->
    <a href="#main" class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-primary text-primary-foreground px-4 py-2 rounded-full font-medium z-50">
        Skip to main content
    </a>

    <div class="flex flex-col min-h-screen">
        <!-- Announcement Bar -->
        {% block announcement_bar %}
        {% include "partials/announcement_bar.html" %}
        {% endblock %}

        <!-- Header -->
        {% block header %}
        {% include "partials/header.html" %}
        {% endblock %}

        <!-- Main content -->
        <main id="main" class="flex-1" role="main" tabindex="-1">
            {% block content %}{% endblock %}
        </main>

        <!-- Footer -->
        {% block footer %}
        {% include "partials/footer.html" %}
        {% endblock %}
    </div>

    <!-- Quick View Sidebar -->
    <div id="quick-view-overlay"
         class="fixed inset-0 bg-black/50 z-40 opacity-0 pointer-events-none transition-opacity duration-300"
         onclick="closeQuickView()"></div>
    <aside id="quick-view-sidebar"
           class="fixed top-0 right-0 h-full w-full max-w-md bg-background z-50 shadow-2xl transform translate-x-full transition-transform duration-300 ease-out overflow-y-auto"
           aria-label="Quick view">
        <div class="sticky top-0 bg-background z-10 flex items-center justify-between p-4 border-b border-border">
            <h2 class="text-sm font-medium uppercase tracking-wider text-muted-foreground">Quick View</h2>
            <button type="button"
                    class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-muted transition-colors"
                    onclick="closeQuickView()"
                    aria-label="Close quick view">
                <i class="ph ph-x text-xl"></i>
            </button>
        </div>
        <div id="quick-view-content" class="p-6">
            <!-- Content loaded via HTMX -->
        </div>
    </aside>

    <!-- Newsletter Popup Container -->
    <div id="newsletter-popup"></div>

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>

    <!-- Base Scripts -->
    <script>
    // Guard against re-execution on HTMX navigation
    if (!window._baseScriptInitialized) {
        window._baseScriptInitialized = true;

        // Global error handler
        window.addEventListener('error', function(e) {
            console.error('JS Error:', e.message, 'at', e.filename, ':', e.lineno);
        });
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
        });

        // HTMX error handling
        document.body.addEventListener('htmx:error', function(e) {
            console.error('HTMX error:', e.detail);
        });
        document.body.addEventListener('htmx:sendError', function(e) {
            console.error('HTMX send error:', e.detail);
        });

        // Quick View functionality
        window.openQuickView = function() {
            var sidebar = document.getElementById('quick-view-sidebar');
            var overlay = document.getElementById('quick-view-overlay');
            if (!sidebar || !overlay) return;

            overlay.classList.remove('opacity-0', 'pointer-events-none');
            overlay.classList.add('opacity-100', 'pointer-events-auto');
            sidebar.classList.remove('translate-x-full');
            sidebar.classList.add('translate-x-0');
            document.body.style.overflow = 'hidden';
        };

        window.closeQuickView = function() {
            var sidebar = document.getElementById('quick-view-sidebar');
            var overlay = document.getElementById('quick-view-overlay');
            if (!sidebar || !overlay) return;

            overlay.classList.add('opacity-0', 'pointer-events-none');
            overlay.classList.remove('opacity-100', 'pointer-events-auto');
            sidebar.classList.add('translate-x-full');
            sidebar.classList.remove('translate-x-0');
            document.body.style.overflow = '';
        };

        // Close on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                window.closeQuickView();
                window.closeMobileMenu();
            }
        });

        // Clean up on HTMX navigation
        document.body.addEventListener('htmx:beforeSwap', function() {
            window.closeQuickView();
        });

        // Mobile menu functionality
        window.openMobileMenu = function() {
            var menu = document.getElementById('mobile-menu');
            var overlay = document.getElementById('mobile-menu-overlay');
            if (!menu || !overlay) return;

            menu.hidden = false;
            overlay.classList.remove('opacity-0', 'invisible');
            overlay.classList.add('opacity-100', 'visible');
            setTimeout(function() {
                menu.classList.add('is-open');
            }, 10);
            document.body.style.overflow = 'hidden';
        };

        window.closeMobileMenu = function() {
            var menu = document.getElementById('mobile-menu');
            var overlay = document.getElementById('mobile-menu-overlay');
            if (!menu || !overlay) return;

            menu.classList.remove('is-open');
            overlay.classList.add('opacity-0', 'invisible');
            overlay.classList.remove('opacity-100', 'visible');
            document.body.style.overflow = '';
            setTimeout(function() {
                menu.hidden = true;
            }, 300);
        };

        // Quantity selector functionality
        document.addEventListener('click', function(e) {
            var btn = e.target.closest('.quantity-btn');
            if (!btn) return;

            var container = btn.closest('.quantity-selector');
            var input = container.querySelector('.quantity-input');
            var currentValue = parseInt(input.value) || 1;
            var min = parseInt(input.min) || 1;
            var max = parseInt(input.max) || 999;

            if (btn.dataset.action === 'decrease' && currentValue > min) {
                input.value = currentValue - 1;
            } else if (btn.dataset.action === 'increase' && currentValue < max) {
                input.value = currentValue + 1;
            }
        });

        // Close quick view when clicking "View Full Details" link
        document.addEventListener('click', function(e) {
            if (e.target.closest('[data-close-quick-view]')) {
                window.closeQuickView();
            }
        });

        // Theme toggle functionality (3-way: light / dark / system)
        window.getThemePreference = function() {
            return localStorage.getItem('theme') || 'system';
        };

        window.getEffectiveTheme = function() {
            var pref = window.getThemePreference();
            if (pref === 'system') {
                return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }
            return pref;
        };

        window.applyTheme = function() {
            var html = document.documentElement;
            var meta = document.getElementById('theme-color-meta');
            var effective = window.getEffectiveTheme();

            if (effective === 'dark') {
                html.classList.add('dark');
                if (meta) meta.setAttribute('content', '#1a1a1a');
            } else {
                html.classList.remove('dark');
                if (meta) meta.setAttribute('content', '#d63a2f');
            }
            window.updateThemeIcons();
        };

        window.setTheme = function(theme) {
            if (theme === 'system') {
                localStorage.removeItem('theme');
            } else {
                localStorage.setItem('theme', theme);
            }
            window.applyTheme();
        };

        window.cycleTheme = function() {
            var current = window.getThemePreference();
            // Cycle: system -> light -> dark -> system
            var next = current === 'system' ? 'light' : (current === 'light' ? 'dark' : 'system');
            window.setTheme(next);
        };

        window.updateThemeIcons = function() {
            var pref = window.getThemePreference();
            document.querySelectorAll('.theme-icon-sun').forEach(function(el) {
                el.classList.toggle('hidden', pref !== 'light');
            });
            document.querySelectorAll('.theme-icon-moon').forEach(function(el) {
                el.classList.toggle('hidden', pref !== 'dark');
            });
            document.querySelectorAll('.theme-icon-system').forEach(function(el) {
                el.classList.toggle('hidden', pref !== 'system');
            });
            // Update aria-label
            document.querySelectorAll('[data-theme-toggle]').forEach(function(el) {
                var labels = { light: 'Light mode (click for dark)', dark: 'Dark mode (click for system)', system: 'System mode (click for light)' };
                el.setAttribute('aria-label', labels[pref] || 'Toggle theme');
            });
        };

        // Initialize theme icons on page load
        window.updateThemeIcons();

        // Listen for system theme changes (applies when preference is 'system')
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function() {
            window.applyTheme();
        });

        // Page component initialization
        window.initPageComponents = function() {
            // Initialize tabs (only if not already initialized)
            document.querySelectorAll('.tabs:not([data-initialized])').forEach(function(tabContainer) {
                var buttons = tabContainer.querySelectorAll('.tab-btn');
                var section = tabContainer.closest('section');
                if (!section) return;
                var panels = section.querySelectorAll('.tab-panel');

                buttons.forEach(function(button) {
                    button.addEventListener('click', function() {
                        var index = button.dataset.index;

                        buttons.forEach(function(btn) {
                            btn.dataset.active = 'false';
                            btn.setAttribute('aria-selected', 'false');
                        });
                        button.dataset.active = 'true';
                        button.setAttribute('aria-selected', 'true');

                        panels.forEach(function(panel) {
                            if (panel.dataset.index === index) {
                                panel.classList.remove('hidden');
                            } else {
                                panel.classList.add('hidden');
                            }
                        });
                    });
                });
                tabContainer.dataset.initialized = 'true';
            });
        };

        // Run on initial page load
        window.initPageComponents();

        // Run after HTMX swaps content (for hx-boost navigation)
        document.body.addEventListener('htmx:afterSettle', window.initPageComponents);
    }
    </script>

    {% block scripts %}{% endblock %}

    <!-- Analytics script - loaded after other scripts -->
    {% block analytics_script %}{% endblock %}
</body>
</html>
