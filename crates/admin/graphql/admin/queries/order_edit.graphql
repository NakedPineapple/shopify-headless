# Order Edit mutations for Shopify Admin API
# These mutations follow a 3-step workflow:
# 1. orderEditBegin - Start an edit session, returns CalculatedOrder
# 2. Apply changes (add/remove items, discounts, shipping)
# 3. orderEditCommit - Finalize all changes

# =============================================================================
# Begin Edit Session
# =============================================================================

# Start an order editing session
mutation OrderEditBegin($id: ID!) {
  orderEditBegin(id: $id) {
    calculatedOrder {
      id
      originalOrder {
        id
        name
      }
      lineItems(first: 100) {
        edges {
          node {
            id
            title
            variantTitle
            sku
            quantity
            editableQuantity
            editableQuantityBeforeChanges
            restockable
            restocking
            hasStagedLineItemDiscount
            originalUnitPriceSet {
              shopMoney {
                amount
                currencyCode
              }
            }
            discountedUnitPriceSet {
              shopMoney {
                amount
                currencyCode
              }
            }
            editableSubtotalSet {
              shopMoney {
                amount
                currencyCode
              }
            }
            image {
              url
              altText
            }
            variant {
              id
            }
            calculatedDiscountAllocations {
              allocatedAmountSet {
                shopMoney {
                  amount
                  currencyCode
                }
              }
            }
          }
        }
      }
      addedLineItems(first: 50) {
        edges {
          node {
            id
            title
            variantTitle
            sku
            quantity
            editableQuantity
            originalUnitPriceSet {
              shopMoney {
                amount
                currencyCode
              }
            }
            discountedUnitPriceSet {
              shopMoney {
                amount
                currencyCode
              }
            }
            editableSubtotalSet {
              shopMoney {
                amount
                currencyCode
              }
            }
            image {
              url
              altText
            }
            variant {
              id
            }
          }
        }
      }
      shippingLines {
        id
        title
        stagedStatus
        price {
          shopMoney {
            amount
            currencyCode
          }
        }
      }
      subtotalPriceSet {
        shopMoney {
          amount
          currencyCode
        }
      }
      totalPriceSet {
        shopMoney {
          amount
          currencyCode
        }
      }
      totalOutstandingSet {
        shopMoney {
          amount
          currencyCode
        }
      }
      subtotalLineItemsQuantity
      notificationPreviewTitle
    }
    userErrors {
      field
      message
    }
  }
}

# =============================================================================
# Line Item Modifications
# =============================================================================

# Add a product variant to the order
mutation OrderEditAddVariant(
  $id: ID!
  $variantId: ID!
  $quantity: Int!
  $locationId: ID
  $allowDuplicates: Boolean
) {
  orderEditAddVariant(
    id: $id
    variantId: $variantId
    quantity: $quantity
    locationId: $locationId
    allowDuplicates: $allowDuplicates
  ) {
    calculatedLineItem {
      id
      title
      variantTitle
      sku
      quantity
      editableQuantity
      originalUnitPriceSet {
        shopMoney {
          amount
          currencyCode
        }
      }
      discountedUnitPriceSet {
        shopMoney {
          amount
          currencyCode
        }
      }
      editableSubtotalSet {
        shopMoney {
          amount
          currencyCode
        }
      }
      image {
        url
        altText
      }
      variant {
        id
      }
    }
    calculatedOrder {
      id
      subtotalPriceSet {
        shopMoney {
          amount
          currencyCode
        }
      }
      totalPriceSet {
        shopMoney {
          amount
          currencyCode
        }
      }
      totalOutstandingSet {
        shopMoney {
          amount
          currencyCode
        }
      }
      subtotalLineItemsQuantity
    }
    userErrors {
      field
      message
    }
  }
}

# Add a custom line item (e.g., gift wrapping, custom service)
mutation OrderEditAddCustomItem(
  $id: ID!
  $title: String!
  $price: MoneyInput!
  $quantity: Int!
  $locationId: ID
  $taxable: Boolean
  $requiresShipping: Boolean
) {
  orderEditAddCustomItem(
    id: $id
    title: $title
    price: $price
    quantity: $quantity
    locationId: $locationId
    taxable: $taxable
    requiresShipping: $requiresShipping
  ) {
    calculatedLineItem {
      id
      title
      quantity
      editableQuantity
      originalUnitPriceSet {
        shopMoney {
          amount
          currencyCode
        }
      }
      editableSubtotalSet {
        shopMoney {
          amount
          currencyCode
        }
      }
    }
    calculatedOrder {
      id
      subtotalPriceSet {
        shopMoney {
          amount
          currencyCode
        }
      }
      totalPriceSet {
        shopMoney {
          amount
          currencyCode
        }
      }
      totalOutstandingSet {
        shopMoney {
          amount
          currencyCode
        }
      }
      subtotalLineItemsQuantity
    }
    userErrors {
      field
      message
    }
  }
}

# Change quantity of a line item (set to 0 to remove)
mutation OrderEditSetQuantity(
  $id: ID!
  $lineItemId: ID!
  $quantity: Int!
  $restock: Boolean
) {
  orderEditSetQuantity(
    id: $id
    lineItemId: $lineItemId
    quantity: $quantity
    restock: $restock
  ) {
    calculatedLineItem {
      id
      title
      variantTitle
      quantity
      editableQuantity
      restocking
      originalUnitPriceSet {
        shopMoney {
          amount
          currencyCode
        }
      }
      discountedUnitPriceSet {
        shopMoney {
          amount
          currencyCode
        }
      }
      editableSubtotalSet {
        shopMoney {
          amount
          currencyCode
        }
      }
    }
    calculatedOrder {
      id
      subtotalPriceSet {
        shopMoney {
          amount
          currencyCode
        }
      }
      totalPriceSet {
        shopMoney {
          amount
          currencyCode
        }
      }
      totalOutstandingSet {
        shopMoney {
          amount
          currencyCode
        }
      }
      subtotalLineItemsQuantity
    }
    userErrors {
      field
      message
    }
  }
}

# =============================================================================
# Discount Modifications
# =============================================================================

# Add a discount to a line item
mutation OrderEditAddLineItemDiscount(
  $id: ID!
  $lineItemId: ID!
  $discount: OrderEditAppliedDiscountInput!
) {
  orderEditAddLineItemDiscount(
    id: $id
    lineItemId: $lineItemId
    discount: $discount
  ) {
    addedDiscountStagedChange {
      __typename
      ... on OrderStagedChangeAddLineItemDiscount {
        id
        value {
          __typename
          ... on MoneyV2 {
            amount
            currencyCode
          }
          ... on PricingPercentageValue {
            percentage
          }
        }
      }
    }
    calculatedLineItem {
      id
      title
      hasStagedLineItemDiscount
      discountedUnitPriceSet {
        shopMoney {
          amount
          currencyCode
        }
      }
      editableSubtotalSet {
        shopMoney {
          amount
          currencyCode
        }
      }
      calculatedDiscountAllocations {
        allocatedAmountSet {
          shopMoney {
            amount
            currencyCode
          }
        }
      }
    }
    calculatedOrder {
      id
      subtotalPriceSet {
        shopMoney {
          amount
          currencyCode
        }
      }
      totalPriceSet {
        shopMoney {
          amount
          currencyCode
        }
      }
      totalOutstandingSet {
        shopMoney {
          amount
          currencyCode
        }
      }
    }
    userErrors {
      field
      message
    }
  }
}

# Update an existing discount
mutation OrderEditUpdateDiscount(
  $id: ID!
  $discountApplicationId: ID!
  $discount: OrderEditAppliedDiscountInput!
) {
  orderEditUpdateDiscount(
    id: $id
    discountApplicationId: $discountApplicationId
    discount: $discount
  ) {
    calculatedOrder {
      id
      subtotalPriceSet {
        shopMoney {
          amount
          currencyCode
        }
      }
      totalPriceSet {
        shopMoney {
          amount
          currencyCode
        }
      }
      totalOutstandingSet {
        shopMoney {
          amount
          currencyCode
        }
      }
    }
    userErrors {
      field
      message
    }
  }
}

# Remove a discount from a line item
mutation OrderEditRemoveDiscount($id: ID!, $discountApplicationId: ID!) {
  orderEditRemoveDiscount(id: $id, discountApplicationId: $discountApplicationId) {
    calculatedOrder {
      id
      subtotalPriceSet {
        shopMoney {
          amount
          currencyCode
        }
      }
      totalPriceSet {
        shopMoney {
          amount
          currencyCode
        }
      }
      totalOutstandingSet {
        shopMoney {
          amount
          currencyCode
        }
      }
    }
    userErrors {
      field
      message
    }
  }
}

# =============================================================================
# Shipping Line Modifications
# =============================================================================

# Add a shipping line to the order
mutation OrderEditAddShippingLine($id: ID!, $shippingLine: OrderEditAddShippingLineInput!) {
  orderEditAddShippingLine(id: $id, shippingLine: $shippingLine) {
    calculatedShippingLine {
      id
      title
      stagedStatus
      price {
        shopMoney {
          amount
          currencyCode
        }
      }
    }
    calculatedOrder {
      id
      shippingLines {
        id
        title
        stagedStatus
        price {
          shopMoney {
            amount
            currencyCode
          }
        }
      }
      subtotalPriceSet {
        shopMoney {
          amount
          currencyCode
        }
      }
      totalPriceSet {
        shopMoney {
          amount
          currencyCode
        }
      }
      totalOutstandingSet {
        shopMoney {
          amount
          currencyCode
        }
      }
    }
    userErrors {
      field
      message
    }
  }
}

# Update an existing shipping line (only works for staged/newly added lines)
mutation OrderEditUpdateShippingLine(
  $id: ID!
  $shippingLineId: ID!
  $shippingLine: OrderEditUpdateShippingLineInput!
) {
  orderEditUpdateShippingLine(
    id: $id
    shippingLineId: $shippingLineId
    shippingLine: $shippingLine
  ) {
    calculatedOrder {
      id
      shippingLines {
        id
        title
        stagedStatus
        price {
          shopMoney {
            amount
            currencyCode
          }
        }
      }
      totalPriceSet {
        shopMoney {
          amount
          currencyCode
        }
      }
      totalOutstandingSet {
        shopMoney {
          amount
          currencyCode
        }
      }
    }
    userErrors {
      field
      message
    }
  }
}

# Remove a shipping line from the order
mutation OrderEditRemoveShippingLine($id: ID!, $shippingLineId: ID!) {
  orderEditRemoveShippingLine(id: $id, shippingLineId: $shippingLineId) {
    calculatedOrder {
      id
      shippingLines {
        id
        title
        stagedStatus
        price {
          shopMoney {
            amount
            currencyCode
          }
        }
      }
      totalPriceSet {
        shopMoney {
          amount
          currencyCode
        }
      }
      totalOutstandingSet {
        shopMoney {
          amount
          currencyCode
        }
      }
    }
    userErrors {
      field
      message
    }
  }
}

# =============================================================================
# Commit Changes
# =============================================================================

# Finalize all changes and update the order
mutation OrderEditCommit($id: ID!, $notifyCustomer: Boolean, $staffNote: String) {
  orderEditCommit(id: $id, notifyCustomer: $notifyCustomer, staffNote: $staffNote) {
    order {
      id
      name
      displayFinancialStatus
      displayFulfillmentStatus
      subtotalPriceSet {
        shopMoney {
          amount
          currencyCode
        }
      }
      totalPriceSet {
        shopMoney {
          amount
          currencyCode
        }
      }
      totalOutstandingSet {
        shopMoney {
          amount
          currencyCode
        }
      }
      lineItems(first: 50) {
        edges {
          node {
            id
            title
            variantTitle
            quantity
            currentQuantity
          }
        }
      }
    }
    successMessages
    userErrors {
      field
      message
    }
  }
}
