{% extends "layouts/base.html" %}

{% block title %}Admin Users{% endblock %}

{% block page_title %}Admin Users{% endblock %}

{% block page_subtitle %}
<p class="text-sm text-muted-foreground mt-1">Manage admin accounts and invites</p>
{% endblock %}

{% block page_actions %}
<button type="button"
        onclick="openInviteModal()"
        class="px-4 py-2 bg-primary text-white rounded-lg text-sm font-medium hover:bg-primary/90 transition-colors flex items-center gap-2">
    <i class="ph ph-user-plus"></i>
    Invite Admin
</button>
{% endblock %}

{% block content %}
<!-- Error Container for HTMX responses -->
<div id="error-container"></div>

<!-- Pending Invites Section -->
<div class="mb-8">
    <h2 class="text-lg font-semibold text-foreground mb-4 flex items-center gap-2">
        <i class="ph ph-envelope-simple text-primary"></i>
        Pending Invites
    </h2>
    <div class="bg-card rounded-xl border border-border overflow-hidden">
        <div class="overflow-hidden md:overflow-x-auto">
            <table class="w-full data-table-cards">
                <thead class="bg-muted">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Invitee</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Role</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Expires</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-muted-foreground uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="invites-table-body" class="divide-y divide-border">
                    {% if pending_invites.is_empty() %}
                    <tr id="no-invites-row">
                        <td colspan="5" class="px-6 py-8 text-center text-muted-foreground">
                            <i class="ph ph-envelope-simple text-3xl mb-2"></i>
                            <p class="text-sm">No pending invites</p>
                        </td>
                    </tr>
                    {% else %}
                    {% for invite in pending_invites %}
                    {% include "_invite_row.html" %}
                    {% endfor %}
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Admin Users Section -->
<div>
    <h2 class="text-lg font-semibold text-foreground mb-4 flex items-center gap-2">
        <i class="ph ph-users text-primary"></i>
        Admin Users
    </h2>
    <div class="bg-card rounded-xl border border-border overflow-hidden">
        <div class="overflow-hidden md:overflow-x-auto">
            <table class="w-full data-table-cards">
                <thead class="bg-muted">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">User</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Role</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Created</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-muted-foreground uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="users-table-body" class="divide-y divide-border">
                    {% if users.is_empty() %}
                    <tr>
                        <td colspan="4" class="px-6 py-12 text-center text-muted-foreground">
                            <i class="ph ph-users text-4xl mb-2"></i>
                            <p>No admin users found</p>
                        </td>
                    </tr>
                    {% else %}
                    {% for user in users %}
                    {% include "_user_row.html" %}
                    {% endfor %}
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Help Text -->
<div class="mt-8 p-4 bg-muted rounded-xl border border-border">
    <div class="flex items-start gap-3">
        <i class="ph ph-info text-xl text-muted-foreground mt-0.5"></i>
        <div class="text-sm text-muted-foreground">
            <p class="font-medium text-foreground mb-1">Inviting New Admins</p>
            <p>Click "Invite Admin" above to create an invite. The invited user can then register at <code class="text-primary">/auth/setup</code> using their email address.</p>
        </div>
    </div>
</div>

<!-- Invite Modal -->
<div id="invite-modal" class="fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-black/50" onclick="closeInviteModal()"></div>
    <div class="fixed inset-0 flex items-center justify-center p-4 pointer-events-none">
        <div class="bg-card rounded-xl border border-border w-full max-w-lg pointer-events-auto">
            <div class="px-6 py-4 border-b border-border flex items-center justify-between">
                <h3 class="font-semibold text-foreground">Invite New Admin</h3>
                <button type="button" onclick="closeInviteModal()" class="text-muted-foreground hover:text-foreground">
                    <i class="ph ph-x text-xl"></i>
                </button>
            </div>

            <form id="invite-form"
                  hx-post="/admin-users/invites"
                  hx-target="#invites-table-body"
                  hx-swap="afterbegin"
                  hx-on::after-request="if(event.detail.successful) { closeInviteModal(); removeNoInvitesRow(); }"
                  class="p-6 space-y-4">

                <div id="invite-form-error" class="hidden p-3 bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-400 text-sm rounded"></div>

                <div>
                    <label for="invite-email" class="block text-sm font-medium text-foreground mb-1">
                        Email <span class="text-red-500">*</span>
                    </label>
                    <input type="email" id="invite-email" name="email" required
                           placeholder="admin@example.com"
                           class="w-full px-3 py-2 bg-input rounded-lg text-foreground border-0 focus:ring-2 focus:ring-ring">
                </div>

                <div>
                    <label for="invite-name" class="block text-sm font-medium text-foreground mb-1">
                        Name <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="invite-name" name="name" required
                           placeholder="John Doe"
                           class="w-full px-3 py-2 bg-input rounded-lg text-foreground border-0 focus:ring-2 focus:ring-ring">
                </div>

                <div>
                    <label for="invite-role" class="block text-sm font-medium text-foreground mb-1">
                        Role <span class="text-red-500">*</span>
                    </label>
                    <select id="invite-role" name="role" required
                            class="w-full px-3 py-2 bg-input rounded-lg text-foreground border-0 focus:ring-2 focus:ring-ring">
                        <option value="admin">Admin</option>
                        <option value="super_admin">Super Admin</option>
                    </select>
                    <p class="text-xs text-muted-foreground mt-1">Super Admins can manage other admin users and connect Shopify.</p>
                </div>

                <div>
                    <label for="invite-expires" class="block text-sm font-medium text-foreground mb-1">
                        Expires In
                    </label>
                    <select id="invite-expires" name="expires_in_days"
                            class="w-full px-3 py-2 bg-input rounded-lg text-foreground border-0 focus:ring-2 focus:ring-ring">
                        <option value="7" selected>7 days</option>
                        <option value="14">14 days</option>
                        <option value="30">30 days</option>
                    </select>
                </div>

                <div class="flex items-center gap-3 pt-4">
                    <button type="submit"
                            class="px-6 py-2.5 bg-primary text-white rounded-lg font-medium hover:bg-primary/90 transition-colors">
                        <i class="ph ph-paper-plane-tilt mr-2"></i>
                        Send Invite
                    </button>
                    <button type="button" onclick="closeInviteModal()"
                            class="px-6 py-2.5 bg-muted text-foreground rounded-lg font-medium hover:bg-accent transition-colors">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete User Modal -->
<div id="delete-user-modal" class="fixed inset-0 z-50 hidden">
    <div class="fixed inset-0 bg-black/50" onclick="closeDeleteUserModal()"></div>
    <div class="fixed inset-0 flex items-center justify-center p-4 pointer-events-none">
        <div class="bg-card rounded-xl border border-border w-full max-w-lg pointer-events-auto">
            <div class="px-6 py-4 border-b border-border flex items-center justify-between">
                <h3 class="font-semibold text-foreground">Delete Admin User</h3>
                <button type="button" onclick="closeDeleteUserModal()" class="text-muted-foreground hover:text-foreground">
                    <i class="ph ph-x text-xl"></i>
                </button>
            </div>

            <form id="delete-user-form"
                  hx-swap="delete"
                  hx-on::after-request="if(event.detail.successful) closeDeleteUserModal()"
                  class="p-6">

                <div class="mb-4 p-4 bg-red-50 dark:bg-red-950/20 border border-red-200 dark:border-red-900/30 rounded-lg">
                    <div class="flex items-start gap-2">
                        <i class="ph ph-warning text-red-600 dark:text-red-400 mt-0.5"></i>
                        <div class="text-sm text-red-800 dark:text-red-300">
                            <p class="font-medium mb-1">This action cannot be undone</p>
                            <p>The user <strong id="delete-user-name"></strong> will be permanently deleted along with all their credentials and sessions.</p>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label for="confirm-email" class="block text-sm font-medium text-foreground mb-1">
                        Type <code id="delete-user-email" class="text-primary"></code> to confirm
                    </label>
                    <input type="text" id="confirm-email" name="confirm_email" required
                           placeholder="Enter the user's email"
                           class="w-full px-3 py-2 bg-input rounded-lg text-foreground border-0 focus:ring-2 focus:ring-ring"
                           autocomplete="off">
                </div>

                <div class="flex items-center gap-3 pt-4">
                    <button type="submit"
                            class="px-6 py-2.5 bg-destructive text-white rounded-lg font-medium hover:bg-destructive/90 transition-colors">
                        <i class="ph ph-trash mr-2"></i>
                        Delete User
                    </button>
                    <button type="button" onclick="closeDeleteUserModal()"
                            class="px-6 py-2.5 bg-muted text-foreground rounded-lg font-medium hover:bg-accent transition-colors">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function openInviteModal() {
    document.getElementById('invite-modal').classList.remove('hidden');
    document.getElementById('invite-form').reset();
    document.getElementById('invite-form-error').classList.add('hidden');
    document.getElementById('invite-email').focus();
}

function closeInviteModal() {
    document.getElementById('invite-modal').classList.add('hidden');
}

function removeNoInvitesRow() {
    const row = document.getElementById('no-invites-row');
    if (row) row.remove();
}

function openDeleteUserModal(id, name, email) {
    const modal = document.getElementById('delete-user-modal');
    const form = document.getElementById('delete-user-form');

    document.getElementById('delete-user-name').textContent = name;
    document.getElementById('delete-user-email').textContent = email;
    document.getElementById('confirm-email').value = '';

    form.setAttribute('hx-post', `/admin-users/${id}/delete`);
    form.setAttribute('hx-target', `#user-row-${id}`);
    htmx.process(form);

    modal.classList.remove('hidden');
    document.getElementById('confirm-email').focus();
}

function closeDeleteUserModal() {
    document.getElementById('delete-user-modal').classList.add('hidden');
}

// Handle HTMX errors
document.body.addEventListener('htmx:responseError', function(event) {
    const errorContainer = document.getElementById('error-container');
    if (errorContainer) {
        errorContainer.innerHTML = `<div class="mb-4 p-3 bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-400 text-sm rounded">
            An error occurred. Please try again.
        </div>`;
        setTimeout(() => errorContainer.innerHTML = '', 5000);
    }
});

// Close modals on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeInviteModal();
        closeDeleteUserModal();
    }
});
</script>
{% endblock %}
