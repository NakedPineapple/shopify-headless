{% extends "layouts/base.html" %}

{% block title %}{{ order.name }} - Orders{% endblock %}

{% block page_title %}Order {{ order.name }}{% endblock %}

{% block page_subtitle %}
<p class="text-sm text-muted-foreground mt-1">
    {{ order.created_at }}
    {% if order.is_test %}<span class="ml-2 text-warning">(Test Order)</span>{% endif %}
</p>
{% endblock %}

{% block content %}
<!-- Action Bar with Back Link and More Actions -->
{% include "orders/_action_bar.html" %}

<!-- Error Banner -->
{% if let Some(err) = error %}
<div class="mb-6 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl p-4">
    <div class="flex items-center gap-3">
        <i class="ph ph-warning-circle text-xl text-destructive"></i>
        <p class="text-sm text-red-800 dark:text-red-200">{{ err }}</p>
    </div>
</div>
{% endif %}

<div class="grid lg:grid-cols-3 gap-6">
    <!-- Main Content -->
    <div class="lg:col-span-2 space-y-6">
        <!-- Order Status Section -->
        {% include "orders/_status_section.html" %}

        <!-- Unfulfilled Items Section -->
        {% include "orders/_unfulfilled_section.html" %}

        <!-- Fulfilled Items Section -->
        {% include "orders/_fulfillments_section.html" %}

        <!-- Line Items (if no fulfillment orders) -->
        {% if order.fulfillment_orders.is_empty() && order.fulfillments.is_empty() %}
        <div class="bg-card rounded-xl border border-border">
            <div class="px-6 py-4 border-b border-border">
                <h3 class="text-lg font-semibold text-foreground">Items</h3>
            </div>
            <div class="divide-y divide-border">
                {% for item in order.line_items %}
                <div class="px-6 py-4 flex items-center justify-between">
                    <div class="flex-1">
                        <p class="font-medium text-foreground">{{ item.title }}</p>
                        {% if let Some(variant) = item.variant_title %}
                        <p class="text-sm text-muted-foreground">{{ variant }}</p>
                        {% endif %}
                        {% if let Some(sku) = item.sku %}
                        <p class="text-xs text-muted-foreground">SKU: {{ sku }}</p>
                        {% endif %}
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-foreground">{{ item.unit_price }} x {{ item.quantity }}</p>
                        <p class="font-medium text-foreground">{{ item.total_price }}</p>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Payment Section -->
        {% include "orders/_payment_section.html" %}

        <!-- Timeline Section -->
        {% include "orders/_timeline_section.html" %}
    </div>

    <!-- Sidebar -->
    <div class="space-y-6">
        <!-- Customer Card -->
        {% include "orders/_customer_card.html" %}

        <!-- Tags Card -->
        {% include "orders/_tags_card.html" %}

        <!-- Risk Card -->
        {% include "orders/_risk_card.html" %}

        <!-- Shipping Address -->
        {% if let Some(addr) = order.shipping_address %}
        <div class="bg-card rounded-xl border border-border p-6">
            <h3 class="text-lg font-semibold text-foreground mb-4">Shipping Address</h3>
            <div class="text-sm text-muted-foreground space-y-1">
                <p class="font-medium text-foreground">{{ addr.name }}</p>
                {% if let Some(company) = addr.company %}
                <p>{{ company }}</p>
                {% endif %}
                <p>{{ addr.line1 }}</p>
                {% if let Some(line2) = addr.line2 %}
                <p>{{ line2 }}</p>
                {% endif %}
                <p>{{ addr.city_state_zip }}</p>
                <p>{{ addr.country }}</p>
                {% if let Some(phone) = addr.phone %}
                <p class="pt-2">{{ phone }}</p>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Billing Address -->
        {% if let Some(addr) = order.billing_address %}
        <div class="bg-card rounded-xl border border-border p-6">
            <h3 class="text-lg font-semibold text-foreground mb-4">Billing Address</h3>
            <div class="text-sm text-muted-foreground space-y-1">
                <p class="font-medium text-foreground">{{ addr.name }}</p>
                {% if let Some(company) = addr.company %}
                <p>{{ company }}</p>
                {% endif %}
                <p>{{ addr.line1 }}</p>
                {% if let Some(line2) = addr.line2 %}
                <p>{{ line2 }}</p>
                {% endif %}
                <p>{{ addr.city_state_zip }}</p>
                <p>{{ addr.country }}</p>
            </div>
        </div>
        {% endif %}

        <!-- Order Note -->
        <div class="bg-card rounded-xl border border-border p-6">
            <h3 class="text-lg font-semibold text-foreground mb-4">Note</h3>
            <form action="/orders/{{ order.short_id }}/note" method="POST">
                <textarea name="note"
                          rows="3"
                          placeholder="Add a note..."
                          class="w-full px-3 py-2 bg-input border border-border rounded-lg text-sm text-foreground focus:ring-2 focus:ring-ring focus:border-ring transition-colors placeholder:text-muted-foreground">{{ order.note.as_deref().unwrap_or("") }}</textarea>
                <button type="submit" class="mt-2 px-4 py-2 bg-primary text-primary-foreground rounded-lg text-sm font-medium hover:bg-primary/90 transition-colors">
                    Save Note
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Modals -->
<!-- Cancel Order Modal -->
<div id="cancel-modal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4">
        <div class="fixed inset-0 bg-black/50" onclick="document.getElementById('cancel-modal').classList.add('hidden')"></div>
        <div class="relative bg-card rounded-xl border border-border max-w-md w-full p-6">
            <h3 class="text-lg font-semibold text-foreground mb-4">Cancel Order</h3>
            <form action="/orders/{{ order.short_id }}/cancel" method="POST">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-foreground mb-2">Reason</label>
                        <select name="reason" class="w-full px-3 py-2 bg-input border border-border rounded-lg text-sm text-foreground">
                            <option value="CUSTOMER">Customer request</option>
                            <option value="FRAUD">Suspected fraud</option>
                            <option value="INVENTORY">Out of stock</option>
                            <option value="DECLINED">Payment declined</option>
                            <option value="OTHER">Other</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label class="flex items-center gap-2 text-sm text-foreground">
                            <input type="checkbox" name="notify_customer" class="rounded border-border">
                            Notify customer
                        </label>
                        <label class="flex items-center gap-2 text-sm text-foreground">
                            <input type="checkbox" name="refund" class="rounded border-border">
                            Issue refund
                        </label>
                        <label class="flex items-center gap-2 text-sm text-foreground">
                            <input type="checkbox" name="restock" checked class="rounded border-border">
                            Restock inventory
                        </label>
                    </div>
                </div>
                <div class="mt-6 flex items-center justify-end gap-3">
                    <button type="button"
                            onclick="document.getElementById('cancel-modal').classList.add('hidden')"
                            class="px-4 py-2 bg-card border border-border rounded-lg text-sm font-medium text-foreground">
                        Close
                    </button>
                    <button type="submit" class="px-4 py-2 bg-destructive text-white rounded-lg text-sm font-medium hover:bg-destructive/90 transition-colors">
                        Cancel Order
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Refund Modal -->
{% include "orders/_refund_modal.html" %}

<!-- Return Modal -->
{% include "orders/_return_modal.html" %}
{% endblock %}
