{% extends "layouts/base.html" %}

{% block title %}Payout #{{ payout.short_id }}{% endblock %}

{% block page_title %}Payout #{{ payout.short_id }}{% endblock %}

{% block page_subtitle %}
<div class="flex items-center gap-3 mt-1">
    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {{ payout.status_class }}">
        {{ payout.status }}
    </span>
    <span class="text-sm text-muted-foreground">{{ payout.transaction_type }}</span>
</div>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Back Link -->
    <a href="/payouts" class="inline-flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground">
        <i class="ph ph-arrow-left"></i>
        Back to Payouts
    </a>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Content -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Payout Summary Card -->
            <div class="bg-card rounded-xl border border-border p-6">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-full bg-coral/10 flex items-center justify-center">
                            <i class="ph ph-wallet text-2xl text-coral"></i>
                        </div>
                        <div>
                            <p class="text-2xl font-bold text-foreground">{{ payout.net }}</p>
                            <p class="text-sm text-muted-foreground">Net payout amount</p>
                        </div>
                    </div>
                    <a href="/payouts/{{ payout.short_id }}/export"
                       class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-foreground bg-muted hover:bg-muted/80 rounded-lg transition-colors">
                        <i class="ph ph-download-simple"></i>
                        Export CSV
                    </a>
                </div>

                {% if let Some(summary) = payout.summary %}
                <div class="border-t border-border pt-6">
                    <h3 class="text-sm font-medium text-muted-foreground mb-4">Breakdown</h3>
                    <dl class="space-y-3">
                        <div class="flex justify-between items-center">
                            <dt class="text-sm text-foreground">Charges (Gross)</dt>
                            <dd class="text-sm font-medium text-foreground">{{ summary.charges_gross }}</dd>
                        </div>
                        <div class="flex justify-between items-center">
                            <dt class="text-sm text-muted-foreground">Charges (Fees)</dt>
                            <dd class="text-sm text-muted-foreground">-{{ summary.charges_fee }}</dd>
                        </div>
                        <div class="flex justify-between items-center">
                            <dt class="text-sm text-foreground">Refunds (Gross)</dt>
                            <dd class="text-sm font-medium text-red-600 dark:text-red-400">-{{ summary.refunds_gross }}</dd>
                        </div>
                        <div class="flex justify-between items-center">
                            <dt class="text-sm text-muted-foreground">Refunds (Fees)</dt>
                            <dd class="text-sm text-muted-foreground">{{ summary.refunds_fee }}</dd>
                        </div>
                        <div class="flex justify-between items-center">
                            <dt class="text-sm text-foreground">Adjustments (Gross)</dt>
                            <dd class="text-sm font-medium text-foreground">{{ summary.adjustments_gross }}</dd>
                        </div>
                        <div class="flex justify-between items-center">
                            <dt class="text-sm text-muted-foreground">Adjustments (Fees)</dt>
                            <dd class="text-sm text-muted-foreground">{{ summary.adjustments_fee }}</dd>
                        </div>
                        <div class="flex justify-between items-center pt-3 border-t border-border">
                            <dt class="text-sm font-medium text-foreground">Net Payout</dt>
                            <dd class="text-lg font-bold text-foreground">{{ payout.net }}</dd>
                        </div>
                    </dl>
                </div>
                {% endif %}
            </div>

            <!-- Transactions Table -->
            <div class="bg-card rounded-xl border border-border overflow-hidden">
                <div class="px-6 py-4 border-b border-border">
                    <h3 class="text-lg font-semibold text-foreground">Transactions</h3>
                </div>
                <div class="overflow-hidden md:overflow-x-auto">
                    <table class="w-full data-table-cards">
                        <thead class="bg-muted">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Source</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-muted-foreground uppercase tracking-wider">Order</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-muted-foreground uppercase tracking-wider">Amount</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-muted-foreground uppercase tracking-wider">Fee</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-muted-foreground uppercase tracking-wider">Net</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-border" id="transactions-body">
                            {% if transactions.is_empty() %}
                            <tr>
                                <td colspan="7" class="px-6 py-12 text-center text-muted-foreground">
                                    <i class="ph ph-receipt text-4xl mb-2"></i>
                                    <p>No transactions found</p>
                                </td>
                            </tr>
                            {% else %}
                            {% for tx in transactions %}
                            <tr class="hover:bg-accent transition-colors">
                                <td class="px-6 py-4 text-sm text-foreground" data-label="Date">
                                    {{ tx.date }}
                                </td>
                                <td class="px-6 py-4" data-label="Type">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {{ tx.type_class }}">
                                        {{ tx.transaction_type }}
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-sm text-muted-foreground" data-label="Source">
                                    {{ tx.source }}
                                </td>
                                <td class="px-6 py-4 text-sm" data-label="Order">
                                    {% if let Some(order_id) = tx.order_id %}
                                        <a href="/orders/{{ order_id }}" class="text-primary hover:underline">
                                            {{ tx.order_name.as_deref().unwrap_or("-") }}
                                        </a>
                                    {% else %}
                                        <span class="text-muted-foreground">—</span>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 text-sm text-right text-foreground" data-label="Amount">
                                    {{ tx.amount }}
                                </td>
                                <td class="px-6 py-4 text-sm text-right text-muted-foreground" data-label="Fee">
                                    {{ tx.fee }}
                                </td>
                                <td class="px-6 py-4 text-sm text-right font-medium text-foreground" data-label="Net">
                                    {{ tx.net }}
                                </td>
                            </tr>
                            {% endfor %}
                            {% if has_more_transactions %}
                            <tr id="load-more-row">
                                <td colspan="7" class="px-6 py-4 text-center">
                                    <button
                                        hx-get="/payouts/{{ payout.short_id }}/transactions?cursor={{ transactions_cursor.as_deref().unwrap_or("") }}"
                                        hx-target="#load-more-row"
                                        hx-swap="outerHTML"
                                        class="inline-flex items-center gap-2 text-sm text-primary hover:underline">
                                        <span class="htmx-indicator">
                                            <i class="ph ph-spinner animate-spin"></i>
                                        </span>
                                        Load more transactions
                                        <i class="ph ph-arrow-down"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endif %}
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
            <!-- Payout Info Card -->
            <div class="bg-card rounded-xl border border-border p-6">
                <h3 class="text-sm font-medium text-muted-foreground mb-4">Payout Information</h3>
                <dl class="space-y-3">
                    <div>
                        <dt class="text-xs text-muted-foreground">Payout ID</dt>
                        <dd class="text-sm text-foreground font-mono">{{ payout.short_id }}</dd>
                    </div>
                    <div>
                        <dt class="text-xs text-muted-foreground">Date Issued</dt>
                        <dd class="text-sm text-foreground">
                            {% if let Some(issued) = payout.issued_at %}
                                {{ issued }}
                            {% else %}
                                <span class="text-muted-foreground">—</span>
                            {% endif %}
                        </dd>
                    </div>
                    <div>
                        <dt class="text-xs text-muted-foreground">Type</dt>
                        <dd class="text-sm text-foreground">{{ payout.transaction_type }}</dd>
                    </div>
                    <div>
                        <dt class="text-xs text-muted-foreground">Gross Amount</dt>
                        <dd class="text-sm text-foreground">{{ payout.gross }}</dd>
                    </div>
                </dl>
            </div>

            <!-- Status Timeline -->
            <div class="bg-card rounded-xl border border-border p-6">
                <h3 class="text-sm font-medium text-muted-foreground mb-4">Timeline</h3>
                <div class="relative pl-6 space-y-4">
                    <div class="absolute left-2 top-2 bottom-2 w-px bg-border"></div>
                    {% if let Some(issued) = payout.issued_at %}
                    <div class="relative">
                        <div class="absolute -left-4 w-4 h-4 rounded-full bg-green-500 border-2 border-card"></div>
                        <div>
                            <p class="text-sm font-medium text-foreground">{{ payout.status }}</p>
                            <p class="text-xs text-muted-foreground">{{ issued }}</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
