{# Product search/picker modal #}
{# Used for selecting products for discount eligibility #}
<div class="fixed inset-0 z-50 flex items-center justify-center bg-black/50" id="product-picker-overlay">
    <div class="bg-card rounded-xl border border-border shadow-xl w-full max-w-2xl max-h-[80vh] flex flex-col">
        {# Header #}
        <div class="flex items-center justify-between p-4 border-b border-border">
            <h3 class="text-lg font-semibold text-foreground">Select Products</h3>
            <button type="button"
                    onclick="document.getElementById('product-picker-overlay').remove()"
                    class="p-1 text-muted-foreground hover:text-foreground transition-colors">
                <i class="ph ph-x text-xl"></i>
            </button>
        </div>

        {# Search #}
        <div class="p-4 border-b border-border">
            <div class="relative">
                <i class="ph ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground"></i>
                <input type="search"
                       id="product-search"
                       placeholder="Search products..."
                       hx-get="/api/products/search"
                       hx-trigger="keyup changed delay:300ms"
                       hx-target="#product-results"
                       hx-include="[name='product_query']"
                       name="product_query"
                       class="w-full pl-10 pr-4 py-2 bg-input border border-border rounded-lg text-foreground focus:ring-2 focus:ring-ring focus:border-ring">
            </div>
        </div>

        {# Results #}
        <div class="flex-1 overflow-y-auto p-4" id="product-results">
            <div class="text-center text-muted-foreground py-8">
                <i class="ph ph-package text-4xl mb-2"></i>
                <p>Search for products to add</p>
            </div>
        </div>

        {# Selected items #}
        <div class="p-4 border-t border-border bg-muted/50">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm text-muted-foreground">
                    <span id="selected-count">0</span> products selected
                </span>
                <button type="button"
                        onclick="clearProductSelection()"
                        class="text-sm text-destructive hover:text-destructive/80">
                    Clear all
                </button>
            </div>
            <div id="selected-products" class="flex flex-wrap gap-2"></div>
        </div>

        {# Footer #}
        <div class="flex items-center justify-end gap-3 p-4 border-t border-border">
            <button type="button"
                    onclick="document.getElementById('product-picker-overlay').remove()"
                    class="px-4 py-2 bg-secondary text-secondary-foreground rounded-lg hover:bg-secondary/90 transition-colors">
                Cancel
            </button>
            <button type="button"
                    onclick="confirmProductSelection()"
                    class="px-4 py-2 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 transition-colors">
                Add Selected
            </button>
        </div>
    </div>
</div>

<script>
let selectedProducts = new Map();

function toggleProduct(id, title, image) {
    if (selectedProducts.has(id)) {
        selectedProducts.delete(id);
    } else {
        selectedProducts.set(id, { title, image });
    }
    updateProductSelection();
}

function updateProductSelection() {
    const container = document.getElementById('selected-products');
    const count = document.getElementById('selected-count');
    count.textContent = selectedProducts.size;

    container.innerHTML = '';
    selectedProducts.forEach((product, id) => {
        const chip = document.createElement('span');
        chip.className = 'inline-flex items-center gap-1 px-2 py-1 bg-primary/10 text-primary rounded text-sm';
        chip.innerHTML = `${product.title} <button type="button" onclick="toggleProduct('${id}')" class="hover:text-primary/80">&times;</button>`;
        container.appendChild(chip);
    });
}

function clearProductSelection() {
    selectedProducts.clear();
    updateProductSelection();
    document.querySelectorAll('[data-product-checkbox]').forEach(cb => cb.checked = false);
}

function confirmProductSelection() {
    const ids = Array.from(selectedProducts.keys());
    // Update hidden input with selected product IDs
    const input = document.querySelector('input[name="product_ids"]');
    if (input) input.value = ids.join(',');
    document.getElementById('product-picker-overlay').remove();
}
</script>
