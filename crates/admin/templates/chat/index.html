{% extends "layouts/base.html" %}

{% block title %}AI Chat{% endblock %}

{% block page_title %}AI Chat{% endblock %}

{% block head %}
<!-- Syntax highlighting theme -->
<link rel="stylesheet" href="/static/css/hljs-lagoon.css">
<!-- Chat-specific styles -->
<style>
/* Markdown content styling */
.markdown-content {
    line-height: 1.6;
}
.markdown-content p {
    margin-bottom: 0.75rem;
}
.markdown-content p:last-child {
    margin-bottom: 0;
}
.markdown-content h1, .markdown-content h2, .markdown-content h3,
.markdown-content h4, .markdown-content h5, .markdown-content h6 {
    font-weight: 600;
    margin-top: 1rem;
    margin-bottom: 0.5rem;
}
.markdown-content h1 { font-size: 1.5rem; }
.markdown-content h2 { font-size: 1.25rem; }
.markdown-content h3 { font-size: 1.125rem; }
.markdown-content ul, .markdown-content ol {
    margin: 0.5rem 0;
    padding-left: 1.5rem;
}
.markdown-content ul { list-style-type: disc; }
.markdown-content ol { list-style-type: decimal; }
.markdown-content li { margin-bottom: 0.25rem; }
.markdown-content code:not(pre code) {
    background: hsl(var(--muted));
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    font-size: 0.875em;
    font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, monospace;
}
.markdown-content pre {
    margin: 0.75rem 0;
    border-radius: 0.5rem;
    overflow-x: auto;
}
.markdown-content pre code {
    display: block;
    padding: 1rem;
    font-size: 0.875rem;
    line-height: 1.5;
}
.markdown-content blockquote {
    border-left: 3px solid hsl(var(--border));
    padding-left: 1rem;
    margin: 0.75rem 0;
    color: hsl(var(--muted-foreground));
}
.markdown-content table {
    width: 100%;
    border-collapse: collapse;
    margin: 0.75rem 0;
}
.markdown-content th, .markdown-content td {
    border: 1px solid hsl(var(--border));
    padding: 0.5rem;
    text-align: left;
}
.markdown-content th {
    background: hsl(var(--muted));
    font-weight: 600;
}
.markdown-content a {
    color: hsl(var(--primary));
    text-decoration: underline;
}
.markdown-content a:hover {
    opacity: 0.8;
}

/* Tool message dark mode support */
.tool-use-msg {
    background-color: hsl(210 80% 96%);
    border-color: hsl(210 70% 85%);
}
.tool-use-msg .tool-label { color: hsl(210 70% 40%); }
.tool-use-msg pre { color: hsl(210 60% 30%); }

.dark .tool-use-msg {
    background-color: hsl(210 50% 15%);
    border-color: hsl(210 40% 30%);
}
.dark .tool-use-msg .tool-label { color: hsl(210 60% 70%); }
.dark .tool-use-msg pre { color: hsl(210 40% 80%); }

.tool-result-success {
    background-color: hsl(145 60% 96%);
    border-color: hsl(145 50% 80%);
}
.tool-result-success .tool-label { color: hsl(145 60% 35%); }
.tool-result-success pre { color: hsl(145 50% 25%); }

.dark .tool-result-success {
    background-color: hsl(145 40% 12%);
    border-color: hsl(145 35% 30%);
}
.dark .tool-result-success .tool-label { color: hsl(145 50% 60%); }
.dark .tool-result-success pre { color: hsl(145 35% 75%); }

.tool-result-error {
    background-color: hsl(0 70% 97%);
    border-color: hsl(0 60% 85%);
}
.tool-result-error .tool-label { color: hsl(0 70% 45%); }
.tool-result-error pre { color: hsl(0 60% 35%); }

.dark .tool-result-error {
    background-color: hsl(0 50% 12%);
    border-color: hsl(0 40% 30%);
}
.dark .tool-result-error .tool-label { color: hsl(0 60% 65%); }
.dark .tool-result-error pre { color: hsl(0 45% 75%); }

/* Pending action styling */
.pending-action-msg {
    background-color: hsl(45 90% 96%);
    border-color: hsl(45 80% 70%);
}
.pending-action-msg .action-label { color: hsl(45 80% 35%); }

.dark .pending-action-msg {
    background-color: hsl(45 50% 12%);
    border-color: hsl(45 45% 35%);
}
.dark .pending-action-msg .action-label { color: hsl(45 70% 60%); }

/* =============================================================================
   Debug Panel Styles (POC-style inline per-message debug)
   Dark theme colors that work regardless of app theme
   ============================================================================= */
.debug-bg { background-color: #1e1e1e; }
.debug-bg-header { background-color: #2d2d2d; }
.debug-bg-header:hover { background-color: #3d3d3d; }
.debug-text { color: #d4d4d4; }
.debug-text-muted { color: #9ca3af; }
.debug-text-dimmed { color: #6b7280; }
/* Color-coded left borders for entry types */
.debug-border-request { border-left: 3px solid #3b82f6; }
.debug-border-response { border-left: 3px solid #22c55e; }
.debug-border-tool_call { border-left: 3px solid #a855f7; }
.debug-border-tool_result { border-left: 3px solid #f59e0b; }
.debug-border-error { border-left: 3px solid #ef4444; }
.debug-border-final { border-left: 3px solid #22c55e; }
</style>
{% endblock %}

{% block content %}
<div class="flex h-[calc(100vh-8rem)]">
    <!-- Session sidebar -->
    <div class="w-64 bg-card border-r border-border flex flex-col shrink-0">
        <div class="p-4 border-b border-border">
            <button
                id="new-session-btn"
                class="w-full bg-primary text-primary-foreground py-2 px-4 rounded-md hover:bg-primary/90 transition-colors font-medium"
            >
                New Chat
            </button>
        </div>

        <div id="sessions-list" class="flex-1 overflow-y-auto">
            <!-- Sessions loaded via JS -->
            <div class="p-4 text-muted-foreground text-sm">Loading sessions...</div>
        </div>

        <!-- History link -->
        <div class="p-4 border-t border-border">
            <a href="/chat/history" class="flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground transition-colors">
                <i class="ph ph-clock-counter-clockwise"></i>
                View history
            </a>
        </div>
    </div>

    <!-- Chat area -->
    <div class="flex-1 flex flex-col bg-muted min-w-0">
        <!-- Messages container -->
        <div id="messages" class="flex-1 overflow-y-auto p-6 space-y-4">
            <div id="empty-state" class="flex items-center justify-center h-full text-muted-foreground">
                <div class="text-center">
                    <svg class="mx-auto h-12 w-12 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                    </svg>
                    <p class="text-lg font-medium">Start a conversation</p>
                    <p class="text-sm mt-1">Ask questions about orders, products, customers, or inventory.</p>
                </div>
            </div>
        </div>

        <!-- Input area -->
        <div class="border-t border-border bg-card p-4">
            <form id="message-form" class="flex gap-3">
                <input
                    type="text"
                    id="message-input"
                    name="message"
                    placeholder="Ask about orders, products, customers..."
                    class="flex-1 px-4 py-2 border border-border rounded-md focus:outline-none focus:ring-2 focus:ring-ring focus:border-transparent bg-input text-foreground placeholder:text-muted-foreground"
                    autocomplete="off"
                    disabled
                >
                <button
                    type="submit"
                    id="send-btn"
                    class="bg-primary text-primary-foreground py-2 px-6 rounded-md hover:bg-primary/90 transition-colors font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled
                >
                    Send
                </button>
            </form>
            <p id="status-message" class="text-sm text-muted-foreground mt-2 hidden"></p>
        </div>
    </div>

    {% if admin_user.is_super_admin %}
    <!-- Debug Panel (Super Admin Only) -->
    <div id="debug-panel" class="w-80 bg-card border-l border-border flex flex-col shrink-0 hidden">
        <div class="p-4 border-b border-border flex items-center justify-between">
            <h3 class="font-semibold text-foreground flex items-center gap-2">
                <i class="ph ph-bug text-lg"></i>
                Debug Panel
            </h3>
            <button id="close-debug-btn" class="p-1 text-muted-foreground hover:text-foreground">
                <i class="ph ph-x text-lg"></i>
            </button>
        </div>

        <div id="debug-content" class="flex-1 overflow-y-auto p-4 space-y-4">
            <div class="text-sm text-muted-foreground">Select a session to view debug info</div>
        </div>
    </div>

    <!-- Debug toggle button -->
    <button
        id="toggle-debug-btn"
        class="fixed bottom-20 right-4 w-10 h-10 bg-primary text-primary-foreground rounded-full shadow-lg hover:bg-primary/90 transition-colors flex items-center justify-center"
        title="Toggle Debug Panel"
    >
        <i class="ph ph-bug text-lg"></i>
    </button>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<!-- Markdown rendering libraries -->
<script src="/static/vendor/marked.min.js"></script>
<script src="/static/vendor/dompurify.min.js"></script>
<script src="/static/vendor/highlight.min.js"></script>
<script>
(function() {
    // Configure marked for safe rendering
    marked.setOptions({
        breaks: true,
        gfm: true,
        highlight: function(code, lang) {
            if (lang && hljs.getLanguage(lang)) {
                try {
                    return hljs.highlight(code, { language: lang }).value;
                } catch (e) {}
            }
            return hljs.highlightAuto(code).value;
        }
    });

    // Sanitize HTML with DOMPurify
    function renderMarkdown(text) {
        if (!text) return '';
        const html = marked.parse(text);
        return DOMPurify.sanitize(html, {
            ALLOWED_TAGS: ['p', 'br', 'strong', 'em', 'b', 'i', 'code', 'pre', 'ul', 'ol', 'li',
                          'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'blockquote', 'a', 'table',
                          'thead', 'tbody', 'tr', 'th', 'td', 'span', 'div'],
            ALLOWED_ATTR: ['href', 'class', 'target', 'rel'],
            ADD_ATTR: ['target'],
            FORBID_TAGS: ['style', 'script', 'iframe', 'form', 'input'],
            ALLOW_DATA_ATTR: false
        });
    }

    // State
    let currentSessionId = null;
    let isLoading = false;
    let debugPanelOpen = false;
    let currentDebugInfo = null; // Stores debug info for current session
    const isSuperAdmin = {{ admin_user.is_super_admin }};

    // DOM elements
    const sessionsListEl = document.getElementById('sessions-list');
    const messagesEl = document.getElementById('messages');
    const emptyStateEl = document.getElementById('empty-state');
    const messageForm = document.getElementById('message-form');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const newSessionBtn = document.getElementById('new-session-btn');
    const statusMessageEl = document.getElementById('status-message');

    // Debug panel elements (super admin only)
    const debugPanel = document.getElementById('debug-panel');
    const debugContent = document.getElementById('debug-content');
    const toggleDebugBtn = document.getElementById('toggle-debug-btn');
    const closeDebugBtn = document.getElementById('close-debug-btn');

    // Load sessions on page load
    loadSessions();

    // Check for session param in URL
    const urlParams = new URLSearchParams(window.location.search);
    const sessionParam = urlParams.get('session');
    if (sessionParam) {
        setTimeout(() => selectSession(parseInt(sessionParam)), 100);
    }

    // Event listeners
    newSessionBtn.addEventListener('click', createSession);
    messageForm.addEventListener('submit', handleSubmit);

    // Debug panel toggle (super admin only)
    if (isSuperAdmin && toggleDebugBtn) {
        toggleDebugBtn.addEventListener('click', toggleDebugPanel);
        closeDebugBtn.addEventListener('click', () => {
            debugPanel.classList.add('hidden');
            debugPanelOpen = false;
        });
    }

    function toggleDebugPanel() {
        debugPanelOpen = !debugPanelOpen;
        debugPanel.classList.toggle('hidden', !debugPanelOpen);
        if (debugPanelOpen && currentSessionId) {
            loadDebugInfo(currentSessionId);
        }
    }

    async function loadSessions() {
        try {
            const response = await fetch('/chat/sessions');
            const sessions = await response.json();

            if (sessions.length === 0) {
                sessionsListEl.innerHTML = '<div class="p-4 text-muted-foreground text-sm">No chat sessions yet</div>';
            } else {
                sessionsListEl.innerHTML = sessions.map(session => `
                    <button
                        class="session-item w-full text-left px-4 py-3 hover:bg-accent border-b border-border"
                        data-session-id="${session.id}"
                    >
                        <div class="font-medium text-sm truncate text-foreground">${escapeHtml(session.title || 'Untitled')}</div>
                        <div class="text-xs text-muted-foreground">${formatDate(session.updated_at)}</div>
                    </button>
                `).join('');

                // Add click handlers
                sessionsListEl.querySelectorAll('.session-item').forEach(item => {
                    item.addEventListener('click', () => selectSession(parseInt(item.dataset.sessionId)));
                });
            }
        } catch (error) {
            sessionsListEl.innerHTML = '<div class="p-4 text-destructive text-sm">Failed to load sessions</div>';
        }
    }

    async function createSession() {
        try {
            newSessionBtn.disabled = true;
            newSessionBtn.textContent = 'Creating...';

            const response = await fetch('/chat/sessions', { method: 'POST' });
            const session = await response.json();

            await loadSessions();
            selectSession(session.id);
        } catch (error) {
            showStatus('Failed to create session', 'error');
        } finally {
            newSessionBtn.disabled = false;
            newSessionBtn.textContent = 'New Chat';
        }
    }

    async function selectSession(sessionId) {
        currentSessionId = sessionId;
        currentDebugInfo = null;

        // Update UI
        sessionsListEl.querySelectorAll('.session-item').forEach(item => {
            item.classList.toggle('bg-accent', parseInt(item.dataset.sessionId) === sessionId);
        });

        messageInput.disabled = false;
        sendBtn.disabled = false;
        emptyStateEl.classList.add('hidden');

        // Load messages and debug info in parallel for super admins
        try {
            const requests = [fetch(`/chat/sessions/${sessionId}`)];
            if (isSuperAdmin) {
                requests.push(fetch(`/chat/sessions/${sessionId}/debug`));
            }

            const responses = await Promise.all(requests);
            const data = await responses[0].json();

            // Load debug info for super admins
            if (isSuperAdmin && responses[1]?.ok) {
                currentDebugInfo = await responses[1].json();
            }

            renderMessages(data.messages);

            // Update sidebar debug panel if open
            if (isSuperAdmin && debugPanelOpen && currentDebugInfo) {
                renderDebugInfo(currentDebugInfo);
            }
        } catch (error) {
            showStatus('Failed to load messages', 'error');
        }
    }

    async function loadDebugInfo(sessionId) {
        if (!isSuperAdmin || !debugContent) return;

        debugContent.innerHTML = '<div class="text-sm text-muted-foreground">Loading...</div>';

        try {
            const response = await fetch(`/chat/sessions/${sessionId}/debug`);
            if (!response.ok) {
                throw new Error('Failed to load debug info');
            }
            currentDebugInfo = await response.json();
            renderDebugInfo(currentDebugInfo);
        } catch (error) {
            debugContent.innerHTML = '<div class="text-sm text-destructive">Failed to load debug info</div>';
        }
    }

    function renderDebugInfo(data) {
        const html = `
            <!-- Summary Stats -->
            <div class="bg-muted rounded-lg p-3">
                <h4 class="text-xs font-semibold text-muted-foreground uppercase mb-2">Summary</h4>
                <div class="grid grid-cols-2 gap-2 text-sm">
                    <div>
                        <span class="text-muted-foreground">Input:</span>
                        <span class="text-foreground font-medium">${data.total_input_tokens.toLocaleString()}</span>
                    </div>
                    <div>
                        <span class="text-muted-foreground">Output:</span>
                        <span class="text-foreground font-medium">${data.total_output_tokens.toLocaleString()}</span>
                    </div>
                    <div>
                        <span class="text-muted-foreground">API Calls:</span>
                        <span class="text-foreground font-medium">${data.total_api_calls}</span>
                    </div>
                    <div>
                        <span class="text-muted-foreground">Tools:</span>
                        <span class="text-foreground font-medium">${data.total_tool_calls}</span>
                    </div>
                    <div class="col-span-2">
                        <span class="text-muted-foreground">Duration:</span>
                        <span class="text-foreground font-medium">${(data.total_duration_ms / 1000).toFixed(2)}s</span>
                    </div>
                </div>
            </div>

            <!-- API Calls -->
            <details class="group">
                <summary class="cursor-pointer text-sm font-semibold text-foreground flex items-center gap-2">
                    <i class="ph ph-caret-right group-open:rotate-90 transition-transform"></i>
                    API Calls (${data.api_calls.length})
                </summary>
                <div class="mt-2 space-y-2 pl-4">
                    ${data.api_calls.map((call, i) => `
                        <div class="bg-muted rounded p-2 text-xs">
                            <div class="flex justify-between mb-1">
                                <span class="font-medium">#${i + 1}</span>
                                <span class="text-muted-foreground">${call.model}</span>
                            </div>
                            <div class="grid grid-cols-2 gap-1 text-muted-foreground">
                                <span>In: ${call.input_tokens}</span>
                                <span>Out: ${call.output_tokens}</span>
                                <span>Time: ${call.duration_ms}ms</span>
                                <span>${call.stop_reason || '-'}</span>
                            </div>
                            ${call.tools_available ? `
                                <details class="mt-1">
                                    <summary class="cursor-pointer text-muted-foreground">Tools (${call.tools_available.length})</summary>
                                    <div class="mt-1 max-h-32 overflow-y-auto text-muted-foreground">
                                        ${call.tools_available.join(', ')}
                                    </div>
                                </details>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            </details>

            <!-- Tool Executions -->
            <details class="group">
                <summary class="cursor-pointer text-sm font-semibold text-foreground flex items-center gap-2">
                    <i class="ph ph-caret-right group-open:rotate-90 transition-transform"></i>
                    Tool Executions (${data.tool_executions.length})
                </summary>
                <div class="mt-2 space-y-2 pl-4">
                    ${data.tool_executions.length === 0 ? '<div class="text-xs text-muted-foreground">No tool executions</div>' : data.tool_executions.map(tool => `
                        <div class="bg-muted rounded p-2 text-xs">
                            <div class="flex items-center gap-2 mb-1">
                                <i class="ph ph-wrench text-primary"></i>
                                <span class="font-medium">${escapeHtml(tool.tool_name)}</span>
                                ${tool.is_error ? '<span class="text-destructive">(error)</span>' : '<span class="text-green-600">(ok)</span>'}
                            </div>
                            <details>
                                <summary class="cursor-pointer text-muted-foreground">Input</summary>
                                <pre class="mt-1 p-2 bg-background rounded text-xs overflow-x-auto">${escapeHtml(JSON.stringify(tool.input, null, 2))}</pre>
                            </details>
                            ${tool.result ? `
                                <details class="mt-1">
                                    <summary class="cursor-pointer text-muted-foreground">Result</summary>
                                    <pre class="mt-1 p-2 bg-background rounded text-xs overflow-x-auto whitespace-pre-wrap">${escapeHtml(tool.result)}</pre>
                                </details>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            </details>

            <!-- Pending Actions -->
            ${data.pending_actions.length > 0 ? `
                <details class="group">
                    <summary class="cursor-pointer text-sm font-semibold text-foreground flex items-center gap-2">
                        <i class="ph ph-caret-right group-open:rotate-90 transition-transform"></i>
                        Pending Actions (${data.pending_actions.length})
                    </summary>
                    <div class="mt-2 space-y-2 pl-4">
                        ${data.pending_actions.map(action => `
                            <div class="bg-muted rounded p-2 text-xs">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="font-medium">${escapeHtml(action.tool_name)}</span>
                                    <span class="${getStatusColor(action.status)} text-xs px-1.5 py-0.5 rounded">${action.status}</span>
                                </div>
                                ${action.approved_by ? `<div class="text-green-600">Approved by: ${escapeHtml(action.approved_by)}</div>` : ''}
                                ${action.rejected_by ? `<div class="text-destructive">Rejected by: ${escapeHtml(action.rejected_by)}</div>` : ''}
                                <div class="text-muted-foreground mt-1">${formatDate(action.created_at)}</div>
                            </div>
                        `).join('')}
                    </div>
                </details>
            ` : ''}
        `;
        debugContent.innerHTML = html;
    }

    function getStatusColor(status) {
        switch (status.toLowerCase()) {
            case 'pending': return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400';
            case 'approved': return 'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400';
            case 'executed': return 'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400';
            case 'rejected': return 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400';
            case 'failed': return 'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400';
            case 'expired': return 'bg-gray-100 text-gray-800 dark:bg-gray-900/30 dark:text-gray-400';
            default: return 'bg-gray-100 text-gray-800';
        }
    }

    function renderMessages(messages) {
        if (messages.length === 0) {
            messagesEl.innerHTML = '';
            emptyStateEl.classList.remove('hidden');
            messagesEl.appendChild(emptyStateEl);
            return;
        }

        emptyStateEl.classList.add('hidden');
        // Build debug entries for each message from the debug info
        const messageDebugMap = buildMessageDebugMap(messages);
        messagesEl.innerHTML = messages.map(msg => renderMessage(msg, messageDebugMap.get(msg.id))).join('');
        messagesEl.scrollTop = messagesEl.scrollHeight;

        // Add click handlers for debug toggles
        messagesEl.querySelectorAll('.debug-toggle-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const content = this.nextElementSibling;
                const arrow = this.querySelector('.debug-arrow');
                content.classList.toggle('hidden');
                arrow.classList.toggle('rotate-90');
            });
        });
    }

    // Build a map of message ID -> debug entries for that message
    function buildMessageDebugMap(messages) {
        const map = new Map();
        if (!isSuperAdmin || !currentDebugInfo) return map;

        // Find API calls that correspond to each assistant message
        const apiCallsByMsgId = new Map();
        for (const call of currentDebugInfo.api_calls || []) {
            if (!apiCallsByMsgId.has(call.message_id)) {
                apiCallsByMsgId.set(call.message_id, []);
            }
            apiCallsByMsgId.get(call.message_id).push(call);
        }

        // Build debug entries for each message
        for (let i = 0; i < messages.length; i++) {
            const msg = messages[i];
            const entries = [];
            const apiCalls = apiCallsByMsgId.get(msg.id) || [];

            if (msg.role === 'assistant' && apiCalls.length > 0) {
                // Add API call entries
                for (const call of apiCalls) {
                    entries.push({
                        type: 'response',
                        content: `Model: ${call.model}\nStop reason: ${call.stop_reason || 'unknown'}`,
                        tokens: { input: call.input_tokens, output: call.output_tokens }
                    });
                }
            }

            if (msg.role === 'tooluse') {
                entries.push({
                    type: 'tool_call',
                    content: `Tool: ${msg.content.name || 'unknown'}\nInput:\n${JSON.stringify(msg.content.input, null, 2)}`,
                    tokens: null
                });
            }

            if (msg.role === 'toolresult') {
                entries.push({
                    type: 'tool_result',
                    content: truncateForDebug(msg.content.content || '', 2000),
                    tokens: null,
                    isError: msg.content.is_error
                });
            }

            if (entries.length > 0) {
                // Calculate totals for this message
                const totalIn = apiCalls.reduce((sum, c) => sum + c.input_tokens, 0);
                const totalOut = apiCalls.reduce((sum, c) => sum + c.output_tokens, 0);
                map.set(msg.id, { entries, totalIn, totalOut });
            }
        }

        return map;
    }

    function truncateForDebug(s, maxLen) {
        if (s.length <= maxLen) return s;
        return s.substring(0, maxLen) + `...\n[truncated, ${s.length} total chars]`;
    }

    function renderMessage(msg, debugInfo) {
        const isUser = msg.role === 'user';
        const isToolUse = msg.role === 'tooluse';
        const isToolResult = msg.role === 'toolresult';
        const isPendingAction = msg.role === 'pending_action';

        if (isToolUse) {
            const debugPanel = isSuperAdmin && debugInfo ? renderInlineDebugPanel(debugInfo) : '';
            return `
                <div class="flex justify-start">
                    <div class="tool-use-msg border rounded-lg px-4 py-2 max-w-2xl">
                        <div class="tool-label text-xs font-medium mb-1 flex items-center gap-1">
                            <i class="ph ph-wrench"></i>
                            Using tool: ${escapeHtml(msg.content.name || 'unknown')}
                        </div>
                        <pre class="text-xs overflow-x-auto">${escapeHtml(JSON.stringify(msg.content.input, null, 2))}</pre>
                        ${debugPanel}
                    </div>
                </div>
            `;
        }

        if (isToolResult) {
            const isError = msg.content.is_error;
            const debugPanel = isSuperAdmin && debugInfo ? renderInlineDebugPanel(debugInfo) : '';
            return `
                <div class="flex justify-start">
                    <div class="${isError ? 'tool-result-error' : 'tool-result-success'} border rounded-lg px-4 py-2 max-w-2xl">
                        <div class="tool-label text-xs font-medium mb-1 flex items-center gap-1">
                            <i class="ph ${isError ? 'ph-warning' : 'ph-check'}"></i>
                            Tool ${isError ? 'error' : 'result'}
                        </div>
                        <pre class="text-xs overflow-x-auto whitespace-pre-wrap">${escapeHtml(msg.content.content || '')}</pre>
                        ${debugPanel}
                    </div>
                </div>
            `;
        }

        if (isPendingAction) {
            return `
                <div class="flex justify-start">
                    <div class="pending-action-msg border rounded-lg px-4 py-3 max-w-2xl">
                        <div class="action-label text-sm font-medium mb-1 flex items-center gap-2">
                            <i class="ph ph-clock animate-pulse"></i>
                            Pending approval: ${escapeHtml(msg.content.tool_name || 'Action')}
                        </div>
                        <p class="text-sm opacity-80">This action requires Slack approval before execution.</p>
                    </div>
                </div>
            `;
        }

        const text = msg.content.text || '';

        if (isUser) {
            return `
                <div class="flex justify-end">
                    <div class="bg-primary text-primary-foreground rounded-lg px-4 py-3 max-w-2xl">
                        <div class="whitespace-pre-wrap">${escapeHtml(text)}</div>
                    </div>
                </div>
            `;
        }

        // Assistant messages: render markdown + debug panel
        const debugPanel = isSuperAdmin && debugInfo ? renderInlineDebugPanel(debugInfo) : '';
        return `
            <div class="flex justify-start">
                <div class="bg-card border border-border text-foreground rounded-lg px-4 py-3 max-w-2xl">
                    <div class="markdown-content">${renderMarkdown(text)}</div>
                    ${debugPanel}
                </div>
            </div>
        `;
    }

    function renderInlineDebugPanel(debugInfo) {
        const { entries, totalIn, totalOut } = debugInfo;
        if (!entries || entries.length === 0) return '';

        const entriesHtml = entries.map(entry => {
            const icon = getDebugEntryIcon(entry.type);
            const borderClass = `debug-border-${entry.type}`;
            const tokensHtml = entry.tokens
                ? `<span class="ml-auto debug-text-dimmed text-[0.65rem]">${entry.tokens.input} in / ${entry.tokens.output} out</span>`
                : '';

            return `
                <div class="debug-bg rounded-lg overflow-hidden">
                    <div class="flex items-center gap-2 px-3 py-2 debug-bg-header ${borderClass}">
                        ${icon}
                        <span class="debug-text-muted font-medium uppercase text-xs">${entry.type.replace('_', ' ')}</span>
                        ${tokensHtml}
                    </div>
                    <pre class="m-0 px-3 py-2 debug-bg debug-text text-[0.7rem] leading-relaxed overflow-x-auto max-h-48 overflow-y-auto whitespace-pre-wrap break-words">${escapeHtml(entry.content)}</pre>
                </div>
            `;
        }).join('');

        return `
            <div class="border-t border-dashed border-border/50 pt-3 mt-3">
                <button type="button" class="debug-toggle-btn flex items-center gap-2 text-xs text-muted-foreground hover:text-foreground transition-colors">
                    <i class="ph ph-caret-right debug-arrow text-xs transition-transform"></i>
                    <span>Debug Info</span>
                    <span class="text-muted-foreground/60">(${totalIn} in / ${totalOut} out tokens)</span>
                </button>
                <div class="hidden mt-2 space-y-2">
                    ${entriesHtml}
                </div>
            </div>
        `;
    }

    function getDebugEntryIcon(type) {
        switch (type) {
            case 'request': return '<i class="ph ph-arrow-right text-blue-500"></i>';
            case 'response': return '<i class="ph ph-arrow-left text-green-500"></i>';
            case 'tool_call': return '<i class="ph ph-wrench text-purple-500"></i>';
            case 'tool_result': return '<i class="ph ph-database text-amber-500"></i>';
            case 'error': return '<i class="ph ph-warning text-red-500"></i>';
            case 'final': return '<i class="ph ph-check-circle text-green-500"></i>';
            default: return '<i class="ph ph-info text-gray-400"></i>';
        }
    }

    async function handleSubmit(event) {
        event.preventDefault();

        if (!currentSessionId || isLoading) return;

        const message = messageInput.value.trim();
        if (!message) return;

        isLoading = true;
        messageInput.value = '';
        messageInput.disabled = true;
        sendBtn.disabled = true;
        showStatus('Sending message...', 'info');

        // Add user message optimistically
        appendMessage({ role: 'user', content: { text: message } });

        try {
            const response = await fetch(`/chat/sessions/${currentSessionId}/messages/stream`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message })
            });

            if (!response.ok) {
                throw new Error('Failed to send message');
            }

            // Handle SSE stream
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            let currentAssistantMessage = null;

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop() || '';

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const data = line.slice(6);
                        if (data === '[DONE]') continue;

                        try {
                            const event = JSON.parse(data);
                            handleStreamEvent(event, currentAssistantMessage);

                            if (event.type === 'assistant_start') {
                                currentAssistantMessage = { role: 'assistant', content: { text: '' } };
                                appendMessage(currentAssistantMessage);
                            } else if (event.type === 'text_delta' && currentAssistantMessage) {
                                currentAssistantMessage.content.text += event.text;
                                updateLastMessage(currentAssistantMessage);
                            } else if (event.type === 'tool_use') {
                                appendMessage({ role: 'tooluse', content: event });
                            } else if (event.type === 'tool_result') {
                                appendMessage({ role: 'toolresult', content: event });
                            } else if (event.type === 'action_pending') {
                                appendMessage({ role: 'pending_action', content: event });
                            } else if (event.type === 'action_resolved') {
                                // Update any pending action message or just log
                                console.log('Action resolved:', event);
                            }
                        } catch (e) {
                            console.error('Failed to parse SSE event:', e);
                        }
                    }
                }
            }

            hideStatus();
            await loadSessions(); // Refresh session list for updated titles

            // Refresh debug info and re-render messages with debug panels
            if (isSuperAdmin && currentSessionId) {
                try {
                    const debugResponse = await fetch(`/chat/sessions/${currentSessionId}/debug`);
                    if (debugResponse.ok) {
                        currentDebugInfo = await debugResponse.json();
                        // Re-render to add debug panels
                        const msgResponse = await fetch(`/chat/sessions/${currentSessionId}`);
                        const msgData = await msgResponse.json();
                        renderMessages(msgData.messages);
                        // Update sidebar debug panel if open
                        if (debugPanelOpen) {
                            renderDebugInfo(currentDebugInfo);
                        }
                    }
                } catch (e) {
                    console.error('Failed to refresh debug info:', e);
                }
            }
        } catch (error) {
            showStatus('Failed to send message: ' + error.message, 'error');
        } finally {
            isLoading = false;
            messageInput.disabled = false;
            sendBtn.disabled = false;
            messageInput.focus();
        }
    }

    function handleStreamEvent(event, currentMsg) {
        // Event handling is done inline in handleSubmit
    }

    function appendMessage(msg) {
        emptyStateEl.classList.add('hidden');
        const html = renderMessage(msg);
        messagesEl.insertAdjacentHTML('beforeend', html);
        messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function updateLastMessage(msg) {
        const lastMsgEl = messagesEl.lastElementChild;
        if (lastMsgEl) {
            // Check if it's a markdown content element (assistant) or plain text (user)
            const markdownEl = lastMsgEl.querySelector('.markdown-content');
            const textEl = lastMsgEl.querySelector('.whitespace-pre-wrap');

            if (markdownEl) {
                // Assistant message: render markdown
                markdownEl.innerHTML = renderMarkdown(msg.content.text);
                // Re-highlight any code blocks
                markdownEl.querySelectorAll('pre code').forEach(block => {
                    hljs.highlightElement(block);
                });
            } else if (textEl) {
                // User message: plain text
                textEl.textContent = msg.content.text;
            }
        }
        messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function showStatus(message, type) {
        statusMessageEl.textContent = message;
        statusMessageEl.classList.remove('hidden', 'text-muted-foreground', 'text-destructive');
        statusMessageEl.classList.add(type === 'error' ? 'text-destructive' : 'text-muted-foreground');
    }

    function hideStatus() {
        statusMessageEl.classList.add('hidden');
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatDate(isoString) {
        const date = new Date(isoString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;
        if (diffDays < 7) return `${diffDays}d ago`;
        return date.toLocaleDateString();
    }
})();
</script>
{% endblock %}
