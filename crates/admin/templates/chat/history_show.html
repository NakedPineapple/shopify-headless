{% extends "layouts/base.html" %}

{% block title %}{{ session_title }} - Chat History{% endblock %}

{% block page_title %}{{ session_title }}{% endblock %}

{% block head %}
<!-- Syntax highlighting theme -->
<link rel="stylesheet" href="/static/css/hljs-lagoon.css">
<style>
/* Markdown content styling */
.markdown-content { line-height: 1.6; }
.markdown-content p { margin-bottom: 0.75rem; }
.markdown-content p:last-child { margin-bottom: 0; }
.markdown-content h1, .markdown-content h2, .markdown-content h3,
.markdown-content h4, .markdown-content h5, .markdown-content h6 {
    font-weight: 600;
    margin-top: 1rem;
    margin-bottom: 0.5rem;
}
.markdown-content h1 { font-size: 1.5rem; }
.markdown-content h2 { font-size: 1.25rem; }
.markdown-content h3 { font-size: 1.125rem; }
.markdown-content ul, .markdown-content ol { margin: 0.5rem 0; padding-left: 1.5rem; }
.markdown-content ul { list-style-type: disc; }
.markdown-content ol { list-style-type: decimal; }
.markdown-content li { margin-bottom: 0.25rem; }
.markdown-content code:not(pre code) {
    background: hsl(var(--muted));
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
    font-size: 0.875em;
    font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, Consolas, monospace;
}
.markdown-content pre { margin: 0.75rem 0; border-radius: 0.5rem; overflow-x: auto; }
.markdown-content pre code { display: block; padding: 1rem; font-size: 0.875rem; line-height: 1.5; }
.markdown-content blockquote {
    border-left: 3px solid hsl(var(--border));
    padding-left: 1rem;
    margin: 0.75rem 0;
    color: hsl(var(--muted-foreground));
}
.markdown-content table { width: 100%; border-collapse: collapse; margin: 0.75rem 0; }
.markdown-content th, .markdown-content td { border: 1px solid hsl(var(--border)); padding: 0.5rem; text-align: left; }
.markdown-content th { background: hsl(var(--muted)); font-weight: 600; }
.markdown-content a { color: hsl(var(--primary)); text-decoration: underline; }
.markdown-content a:hover { opacity: 0.8; }
</style>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto py-8 px-4">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-4">
            <a href="/chat/history" class="p-2 text-muted-foreground hover:text-foreground hover:bg-accent rounded-md transition-colors">
                <i class="ph ph-arrow-left text-xl"></i>
            </a>
            <div>
                <h1 class="text-xl font-semibold text-foreground">{{ session_title }}</h1>
                <p class="text-sm text-muted-foreground">
                    {% if messages.len() == 1 %}
                        1 message
                    {% else %}
                        {{ messages.len() }} messages
                    {% endif %}
                </p>
            </div>
        </div>
        {% if can_continue %}
        <form action="/chat/history/{{ session_id }}/continue" method="post">
            <button type="submit" class="inline-flex items-center gap-2 bg-primary text-primary-foreground py-2 px-4 rounded-md hover:bg-primary/90 transition-colors font-medium">
                <i class="ph ph-arrow-right"></i>
                Continue Chat
            </button>
        </form>
        {% endif %}
    </div>

    <!-- Messages -->
    {% if messages.is_empty() %}
    <div class="text-center py-12 bg-card border border-border rounded-lg">
        <i class="ph ph-chat-circle text-5xl text-muted-foreground mb-4"></i>
        <h3 class="text-lg font-medium text-foreground mb-2">No messages</h3>
        <p class="text-muted-foreground">This conversation is empty.</p>
    </div>
    {% else %}
    <div class="space-y-4 bg-muted p-6 rounded-lg">
        {% for message in messages %}
            {% if message.role == "user" %}
            <div class="flex justify-end">
                <div class="bg-primary text-primary-foreground rounded-lg px-4 py-3 max-w-2xl">
                    <div class="whitespace-pre-wrap">{{ message.content["text"]|as_str_or_empty }}</div>
                    <div class="text-xs opacity-70 mt-2">{{ message.created_at|datetime_short }}</div>
                </div>
            </div>
            {% elif message.role == "assistant" %}
            <div class="flex justify-start">
                <div class="bg-card border border-border text-foreground rounded-lg px-4 py-3 max-w-2xl">
                    <div class="markdown-content assistant-message-content" data-raw-content="{{ message.content["text"]|as_str_or_empty }}">{{ message.content["text"]|as_str_or_empty }}</div>
                    <div class="text-xs text-muted-foreground mt-2">{{ message.created_at|datetime_short }}</div>
                </div>
            </div>
            {% elif message.role == "tooluse" %}
            <div class="flex justify-start">
                <div class="bg-blue-50 dark:bg-blue-950/30 border border-blue-200 dark:border-blue-800 rounded-lg px-4 py-2 max-w-2xl">
                    <div class="text-xs text-blue-600 dark:text-blue-400 font-medium mb-1">
                        <i class="ph ph-wrench mr-1"></i>
                        Using tool: {{ message.content["name"]|as_str_or_empty }}
                    </div>
                    <pre class="text-xs text-blue-800 dark:text-blue-300 overflow-x-auto">{{ message.content["input"]|json_pretty }}</pre>
                </div>
            </div>
            {% elif message.role == "toolresult" %}
                {% if message.content["is_error"]|as_bool %}
                <div class="flex justify-start">
                    <div class="bg-red-50 dark:bg-red-950/30 border border-red-200 dark:border-red-800 rounded-lg px-4 py-2 max-w-2xl">
                        <div class="text-xs text-red-600 dark:text-red-400 font-medium mb-1">
                            <i class="ph ph-warning mr-1"></i>
                            Tool error
                        </div>
                        <pre class="text-xs text-red-800 dark:text-red-300 overflow-x-auto whitespace-pre-wrap">{{ message.content["content"]|as_str_or_empty }}</pre>
                    </div>
                </div>
                {% else %}
                <div class="flex justify-start">
                    <div class="bg-green-50 dark:bg-green-950/30 border border-green-200 dark:border-green-800 rounded-lg px-4 py-2 max-w-2xl">
                        <div class="text-xs text-green-600 dark:text-green-400 font-medium mb-1">
                            <i class="ph ph-check mr-1"></i>
                            Tool result
                        </div>
                        <pre class="text-xs text-green-800 dark:text-green-300 overflow-x-auto whitespace-pre-wrap">{{ message.content["content"]|as_str_or_empty }}</pre>
                    </div>
                </div>
                {% endif %}
            {% else %}
            <div class="flex justify-start">
                <div class="bg-card border border-border text-foreground rounded-lg px-4 py-3 max-w-2xl">
                    <div class="text-xs text-muted-foreground mb-1">{{ message.role }}</div>
                    <pre class="text-sm overflow-x-auto whitespace-pre-wrap">{{ message.content|json_pretty }}</pre>
                </div>
            </div>
            {% endif %}
        {% endfor %}
    </div>
    {% endif %}

    <!-- Footer Actions -->
    <div class="flex items-center justify-between mt-6 pt-6 border-t border-border">
        <a href="/chat/history" class="text-muted-foreground hover:text-foreground transition-colors">
            <i class="ph ph-arrow-left mr-2"></i>
            Back to history
        </a>
        {% if can_continue %}
        <form action="/chat/history/{{ session_id }}/continue" method="post">
            <button type="submit" class="text-primary hover:underline">
                Continue this conversation
                <i class="ph ph-arrow-right ml-2"></i>
            </button>
        </form>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Markdown rendering libraries -->
<script src="/static/vendor/marked.min.js"></script>
<script src="/static/vendor/dompurify.min.js"></script>
<script src="/static/vendor/highlight.min.js"></script>
<script>
(function() {
    // Configure marked
    marked.setOptions({
        breaks: true,
        gfm: true,
        highlight: function(code, lang) {
            if (lang && hljs.getLanguage(lang)) {
                try {
                    return hljs.highlight(code, { language: lang }).value;
                } catch (e) {}
            }
            return hljs.highlightAuto(code).value;
        }
    });

    // Render markdown for all assistant messages
    document.querySelectorAll('.assistant-message-content').forEach(function(el) {
        var raw = el.getAttribute('data-raw-content') || el.textContent;
        var html = marked.parse(raw);
        var clean = DOMPurify.sanitize(html, {
            ALLOWED_TAGS: ['p', 'br', 'strong', 'em', 'b', 'i', 'code', 'pre', 'ul', 'ol', 'li',
                          'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'blockquote', 'a', 'table',
                          'thead', 'tbody', 'tr', 'th', 'td', 'span', 'div'],
            ALLOWED_ATTR: ['href', 'class', 'target', 'rel'],
            FORBID_TAGS: ['style', 'script', 'iframe', 'form', 'input'],
            ALLOW_DATA_ATTR: false
        });
        el.innerHTML = clean;

        // Highlight code blocks
        el.querySelectorAll('pre code').forEach(function(block) {
            hljs.highlightElement(block);
        });
    });
})();
</script>
{% endblock %}
