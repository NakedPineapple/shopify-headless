{% extends "layouts/base.html" %}

{% block title %}Gift Card {{ gift_card.masked_code }} - Gift Cards{% endblock %}

{% block page_title %}{{ gift_card.masked_code }}{% endblock %}

{% block page_subtitle %}
<p class="text-sm text-muted-foreground mt-1">
    Gift Card ending in {{ gift_card.last_characters }}
</p>
{% endblock %}

{% block content %}
<!-- Action Bar -->
<div class="flex items-center justify-between mb-6">
    <a href="/gift-cards" class="inline-flex items-center gap-2 text-muted-foreground hover:text-foreground transition-colors">
        <i class="ph ph-arrow-left text-lg"></i>
        Back to gift cards
    </a>
    <div class="flex items-center gap-3">
        {% if gift_card.enabled && !gift_card.is_expired %}
        <button hx-post="/gift-cards/{{ gift_card.short_id }}/deactivate"
                hx-confirm="Deactivate this gift card? This action cannot be undone and the remaining balance will be lost."
                hx-target="body"
                hx-swap="outerHTML"
                class="inline-flex items-center gap-2 px-4 py-2 border border-destructive text-destructive rounded-lg hover:bg-destructive/10 transition-colors">
            <i class="ph ph-prohibit text-lg"></i>
            Deactivate
        </button>
        {% endif %}
    </div>
</div>

<div class="grid lg:grid-cols-3 gap-6">
    <!-- Main Content -->
    <div class="lg:col-span-2 space-y-6">
        <!-- Balance Status Card -->
        {% include "gift_cards/_status_card.html" %}

        <!-- Actions Card -->
        {% include "gift_cards/_actions_card.html" %}

        <!-- Transaction History -->
        {% include "gift_cards/_transactions_card.html" %}
    </div>

    <!-- Sidebar -->
    <div class="space-y-6">
        <!-- Customer Card -->
        {% include "gift_cards/_customer_card.html" %}

        <!-- Recipient Card -->
        {% if gift_card.recipient_email.is_some() || gift_card.recipient_name.is_some() %}
        {% include "gift_cards/_recipient_card.html" %}
        {% endif %}

        <!-- Order Card -->
        {% if gift_card.order_id.is_some() %}
        {% include "gift_cards/_order_card.html" %}
        {% endif %}

        <!-- Note Card -->
        {% include "gift_cards/_note_card.html" %}

        <!-- Details Card -->
        {% include "gift_cards/_details_card.html" %}
    </div>
</div>

<!-- Adjust Balance Modal -->
<div id="adjust-balance-modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="document.getElementById('adjust-balance-modal').classList.add('hidden')"></div>
    <div class="absolute inset-4 md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 md:w-full md:max-w-md">
        <div class="bg-card rounded-xl border border-border shadow-2xl overflow-hidden">
            <div class="px-6 py-4 border-b border-border flex items-center justify-between">
                <h3 class="text-lg font-semibold text-foreground">Adjust Balance</h3>
                <button onclick="document.getElementById('adjust-balance-modal').classList.add('hidden')" class="p-1 rounded-lg hover:bg-muted transition-colors">
                    <i class="ph ph-x text-xl text-muted-foreground"></i>
                </button>
            </div>
            <form hx-post="/gift-cards/{{ gift_card.short_id }}/adjust-balance"
                  hx-target="#adjust-balance-error"
                  hx-swap="innerHTML"
                  class="p-6 space-y-4">
                <div id="adjust-balance-error"></div>

                <div>
                    <label class="block text-sm font-medium text-foreground mb-2">Adjustment Type</label>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="adjustment_type" value="credit" checked class="text-primary focus:ring-primary">
                            <span class="text-sm text-foreground">Add funds</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="adjustment_type" value="debit" class="text-primary focus:ring-primary">
                            <span class="text-sm text-foreground">Remove funds</span>
                        </label>
                    </div>
                </div>

                <div>
                    <label for="adjust-amount" class="block text-sm font-medium text-foreground mb-2">Amount</label>
                    <div class="relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground">$</span>
                        <input type="number"
                               id="adjust-amount"
                               name="amount"
                               step="0.01"
                               min="0.01"
                               required
                               placeholder="0.00"
                               class="w-full pl-8 pr-4 py-2 bg-input border border-border rounded-lg text-foreground placeholder:text-muted-foreground focus:ring-2 focus:ring-ring focus:border-ring">
                    </div>
                    <p class="mt-1 text-xs text-muted-foreground">Current balance: {{ gift_card.balance }}</p>
                </div>

                <div>
                    <label for="adjust-note" class="block text-sm font-medium text-foreground mb-2">Note (optional)</label>
                    <textarea id="adjust-note"
                              name="note"
                              rows="2"
                              placeholder="Reason for adjustment..."
                              class="w-full px-4 py-2 bg-input border border-border rounded-lg text-foreground placeholder:text-muted-foreground focus:ring-2 focus:ring-ring focus:border-ring resize-none"></textarea>
                </div>

                <div class="flex justify-end gap-3 pt-2">
                    <button type="button"
                            onclick="document.getElementById('adjust-balance-modal').classList.add('hidden')"
                            class="px-4 py-2 text-muted-foreground hover:text-foreground transition-colors">
                        Cancel
                    </button>
                    <button type="submit"
                            class="px-4 py-2 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 transition-colors">
                        Apply Adjustment
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
